
<!DOCTYPE html>
<html lang="ru">
<head>
  <!-- 1. Мета-теги для кодировки и адаптивности -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="AstroPred - персональный астрологический помощник с натальными картами, прогнозами и обучением">
  <title>AstroPred Mini App</title>
  
  <!-- 2. Подключение библиотек -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <!-- 3. Стили приложения -->
  <style>
    /* 3.1 CSS переменные для темной темы (по умолчанию) */
    :root {
      --primary-color: #9370db;
      --primary-hover: #7b5dc5;
      --secondary-color: #6a5acd;
      --text-color: #f0f0f0;
      --bg-color: #0a0a1a;
      --card-color: rgba(22, 33, 62, 0.9);
      --error-color: #ff6b6b;
      --success-color: #4caf50;
      --info-color: #4285f4;
      --warning-color: #ff9800;
      --panel-width: 85%;
      --transition-speed: 0.3s;
      --border-radius: 12px;
    }
    
    /* 3.2 CSS переменные для светлой темы */
    :root.light-theme {
      --primary-color: #6a5acd;
      --primary-hover: #5a4ab5;
      --secondary-color: #483d8b;
      --text-color: #333333;
      --bg-color: #f5f5f5;
      --card-color: rgba(255, 255, 255, 0.95);
      --error-color: #e74c3c;
      --success-color: #27ae60;
      --info-color: #3498db;
      --warning-color: #f39c12;
    }
    
    /* 3.3 Основные стили тела документа */
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      color: var(--text-color);
      background: var(--bg-color);
      transition: all var(--transition-speed) ease;
      position: relative;
      overflow-x: hidden;
      min-height: 100vh;
      line-height: 1.5;
    }
    
    /* 3.4 Контейнер для звездного фона */
    #stars-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      overflow: hidden;
    }
    
    /* 3.5 Стили для звезд */
    .star {
      position: absolute;
      background-color: var(--text-color);
      border-radius: 50%;
      animation: twinkle var(--duration) infinite ease-in-out;
      opacity: 0.7;
    }
    
    /* 3.6 Анимация мерцания звезд */
    @keyframes twinkle {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 1; }
    }
    
    /* 3.7 Стили главного меню */
    #mainMenu {
      padding: 20px;
      transition: all var(--transition-speed) ease;
      position: relative;
      z-index: 1;
      padding-bottom: 120px;
      max-width: 600px;
      margin: 0 auto;
    }
    
    /* 3.8 Стиль для заголовка анкеты */
    .side-panel > h2 {
      margin-top: 0;
      padding-top: 10px;
      font-size: 1.5rem;
    }
    
    /* 3.9 Контейнер логотипа */
    .logo-container {
      text-align: center;
      margin-bottom: 30px;
      cursor: pointer;
      transition: transform 0.3s ease;
    }
    
    .logo-container:hover {
      transform: scale(1.02);
    }
    
    /* 3.10 Стили SVG логотипа */
    .logo-svg {
      width: 120px;
      height: 120px;
      margin-bottom: 15px;
      filter: drop-shadow(0 0 5px rgba(106, 90, 205, 0.5));
    }
    
    /* 3.11 Текст логотипа */
    .logo-text {
      font-size: 28px;
      font-weight: bold;
      color: var(--primary-color);
      margin-top: 10px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    /* 3.12 Стили главного меню */
    .main-menu {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-top: 20px;
    }
    
    /* 3.13 Боковая панель */
    .side-panel {
      position: fixed;
      top: 0;
      right: -100%;
      width: var(--panel-width);
      height: 100vh;
      background: var(--bg-color);
      box-shadow: -5px 0 15px rgba(0,0,0,0.3);
      z-index: 100;
      overflow-y: auto;
      transition: right var(--transition-speed) ease;
      padding: 50px 20px 20px;
      border-left: 1px solid rgba(255,255,255,0.1);
    }
    
    /* 3.14 Активное состояние боковой панели */
    .side-panel.active {
      right: 0;
    }
    
    /* 3.15 Кнопка закрытия панели */
    .close-panel {
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      color: var(--text-color);
      font-size: 24px;
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    
    .close-panel:hover {
      transform: rotate(90deg);
    }
    
    /* 3.16 Основные стили кнопок */
    .btn {
      position: relative;
      overflow: hidden;
      padding: 15px 10px;
      border-radius: 18px;
      border: none;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      background-color: var(--card-color);
      color: var(--text-color);
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      height: 90px;
      text-align: center;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    /* 3.17 Состояния кнопок */
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.25);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    /* 3.18 Стили для разных типов кнопок */
    .btn-success {
      background-color: var(--success-color);
      color: white;
    }
    
    .btn-success:hover {
      background-color: #219653;
    }
    
    .btn-error {
      background-color: var(--error-color);
      color: white;
    }
    
    .btn-error:hover {
      background-color: #e53935;
    }
    
    .btn-info {
      background-color: var(--info-color);
      color: white;
    }
    
    .btn-info:hover {
      background-color: #1976d2;
    }
    
    .btn-warning {
      background-color: var(--warning-color);
      color: white;
    }
    
    .btn-warning:hover {
      background-color: #e68a00;
    }
    
    /* 3.19 Эффект ripple для кнопок */
    .btn i {
      font-size: 28px;
      margin-bottom: 5px;
      display: block;
    }
    
    /* 3.20 Анимация ripple эффекта */
    .btn::after {
      content: "";
      position: absolute;
      top: 50%;
      left: 50%;
      width: 5px;
      height: 5px;
      background: rgba(255, 255, 255, 0.5);
      opacity: 0;
      border-radius: 100%;
      transform: scale(1, 1) translate(-50%, -50%);
      transform-origin: 50% 50%;
    }
    
    .btn:focus:not(:active)::after {
      animation: ripple 0.6s ease-out;
    }
    
    /* 3.21 Анимация ripple эффекта */
    @keyframes ripple {
      0% {
        transform: scale(0, 0);
        opacity: 0.5;
      }
      100% {
        transform: scale(20, 20);
        opacity: 0;
      }
    }
    
    /* 3.22 Группы полей формы */
    form {
      display: flex;
      flex-direction: column;
      gap: 20px;
      background: var(--card-color);
      padding: 25px;
      border-radius: var(--border-radius);
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
      transition: all var(--transition-speed) ease;
      backdrop-filter: blur(5px);
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    /* 3.23 Стили меток */
    label {
      font-weight: 600;
      display: block;
      margin-bottom: 8px;
      color: var(--text-color);
      font-size: 15px;
    }
    
    label i {
      margin-right: 8px;
      color: var(--primary-color);
      width: 20px;
      text-align: center;
    }
    
    /* 3.24 Стили полей ввода */
    input, select, textarea {
      padding: 12px 15px;
      border-radius: var(--border-radius);
      border: 1px solid rgba(255,255,255,0.2);
      font-size: 16px;
      width: 100%;
      box-sizing: border-box;
      background: rgba(0,0,0,0.2);
      color: var(--text-color);
      transition: all var(--transition-speed) ease;
      font-family: 'Inter', sans-serif;
    }

    /* Специфика для select: добавим стрелочку */
    select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg fill='%23cccccc' height='24' viewBox='0 0 24 24' width='24' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 18px 18px;
      padding-right: 40px;
      cursor: pointer;
    }
  
    /* 3.25 Состояния полей ввода */
    input:focus, select:focus, textarea:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(106, 90, 205, 0.3);
      outline: none;
      background: rgba(0,0,0,0.3);
    }
    
    input:invalid, select:invalid {
      border-color: var(--error-color);
    }
    
    /* 3.26 Контейнер прогресс-бара */
    .progress-container {
      width: 100%;
      background: rgba(0,0,0,0.2);
      border-radius: var(--border-radius);
      margin-bottom: 20px;
      overflow: hidden;
    }
    
    /* 3.27 Прогресс-бар */
    .progress-bar {
      height: 8px;
      background: var(--primary-color);
      border-radius: var(--border-radius);
      transition: width 0.4s ease;
    }
    
    /* 3.28 Шаги прогресса */
    .progress-steps {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
      font-size: 14px;
      color: var(--text-color);
    }
    
    /* 3.29 Стили шагов */
    .step {
      text-align: center;
      flex: 1;
      position: relative;
      font-size: 13px;
      opacity: 0.7;
    }
    
    .step.active {
      color: var(--primary-color);
      font-weight: bold;
      opacity: 1;
    }
    
    .step.completed::before {
      content: "✓";
      color: var(--success-color);
      margin-right: 5px;
    }
    
    /* 3.30 Контейнер прогноза */
    .forecast-container {
      background: var(--card-color);
      padding: 25px;
      border-radius: var(--border-radius);
      margin-top: 20px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
      backdrop-filter: blur(5px);
      border: 1px solid rgba(255,255,255,0.1);
      animation: slideUp 0.5s ease forwards;
    }
    
    /* 3.31 Заголовок прогноза */
    .forecast-header {
      text-align: center;
      margin-bottom: 20px;
      color: var(--primary-color);
    }
    
    /* 3.32 Контент прогноза */
    .forecast-content {
      line-height: 1.6;
    }
    
    /* 3.33 Секции прогноза */
    .forecast-section {
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px dashed rgba(255,255,255,0.1);
    }
    
    /* 3.34 Заголовки секций */
    .forecast-section h3 {
      color: var(--primary-color);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.1rem;
    }
    
    /* 3.35 Просмотр профиля */
    .profile-view {
      background: var(--card-color);
      padding: 25px;
      border-radius: var(--border-radius);
      margin-top: 20px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
      backdrop-filter: blur(5px);
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    /* 3.36 Заголовки профиля */
    .profile-view h3 {
      color: var(--primary-color);
      margin-bottom: 20px 0 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.3rem;
    }
    
    /* 3.37 Параграфы профиля */
    .profile-view p {
      margin-bottom: 10px;
      padding-left: 10px;
    }
    
    /* 3.38 Кнопки "Поделиться" */
    .share-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      justify-content: space-between;
    }

    .share-buttons .btn {
      flex: 1;
      min-width: 0;
    }
    
    /* 3.39 Кнопки внизу экрана */
    .bottom-buttons {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: calc(100% - 40px);
      max-width: 500px;
      z-index: 10;
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding-bottom: env(safe-area-inset-bottom);
    }
    
    /* 3.40 Навигация по форме */
    .form-navigation {
      display: flex;
      justify-content: space-between;
      gap: 15px;
      margin-top: 20px;
    }
    
    .form-navigation .btn {
      flex: 1;
    }
    
    /* 3.41 Бонусное сообщение */
    .bonus-message {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) !important;
      width: calc(100% - 40px);
      max-width: 400px;
      box-sizing: border-box;
      padding: 25px;
      background: var(--card-color);
      border-radius: var(--border-radius);
      box-shadow: 0 8px 25px rgba(0,0,0,0.3);
      z-index: 1000;
      text-align: center;
      display: none;
      overflow: visible;
      white-space: normal;
    }
    
    .bonus-message h3 {
      color: var(--primary-color);
      margin-bottom: 15px;
      font-size: 1.3rem;
    }
    
    .bonus-message p {
      line-height: 1.6;
      margin-bottom: 15px;
    }
    
    .bonus-message .close-bonus {
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      color: var(--text-color);
      font-size: 18px;
      cursor: pointer;
      opacity: 0.7;
      transition: opacity 0.2s;
    }
    
    .bonus-message .close-bonus:hover {
      opacity: 1;
    }
    
    /* 3.42 Оверлей */
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 999;
      display: none;
      backdrop-filter: blur(3px);
    }
    
    /* 3.43 Анимации */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* 3.44 Адаптивные стили */
    @media (max-width: 400px) {
      :root {
        --panel-width: 95%;
      }
      .forecast-container, .profile-view {
        padding: 15px;
      }
    }
      
    @media (max-width: 480px) {
      :root {
        --panel-width: 90%;
      }
      
      .share-buttons {
        flex-direction: row;
        gap: 8px;
      }
      
      .logo-svg {
        width: 100px;
        height: 100px;
      }
      
      .logo-text {
        font-size: 24px;
      }
    }
    
    /* 3.45 Лоадер */
    .loader {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
      margin-left: 10px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* 3.46 Уведомления */
    .notification {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 20px;
      border-radius: var(--border-radius);
      color: white;
      z-index: 1000;
      animation: slideIn 0.3s ease forwards;
      max-width: 90%;
      text-align: center;
    }
    
    .notification.success {
      background-color: var(--success-color);
    }
    
    .notification.error {
      background-color: var(--error-color);
    }
    
    .notification.info {
      background-color: var(--info-color);
    }
    
    .notification.fade-out {
      animation: fadeOut 0.3s ease forwards;
    }
    
    @keyframes slideIn {
      from { bottom: -50px; opacity: 0; }
      to { bottom: 20px; opacity: 1; }
    }
    
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
    
    /* 3.47 Счетчик звезд */
    .stars-counter {
      position: fixed;
      top: 20px;
      left: 20px;
      background: var(--card-color);
      padding: 8px 15px;
      border-radius: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 50;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      font-size: 14px;
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    
    .stars-counter:hover {
      transform: scale(1.05);
    }
    
    .stars-counter i {
      color: gold;
    }
    
    /* 3.48 Анимация получения звезд */
    @keyframes starBounce {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.5); }
    }
    
    .star-added {
      animation: starBounce 0.5s ease;
    }
    
    /* 3.49 Стили для реферальной системы */
    .ref-link {
      background: rgba(0,0,0,0.2);
      padding: 12px;
      border-radius: var(--border-radius);
      margin-top: 15px;
      word-break: break-all;
      text-align: center;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    
    .ref-link:hover {
      background: rgba(0,0,0,0.3);
    }
    
    .ref-link i {
      margin-right: 5px;
    }
    
    /* 3.50 Улучшенные сообщения об ошибках */
    .error-message {
      color: var(--error-color);
      font-size: 13px;
      margin-top: 5px;
      display: none;
    }
    
    input:invalid + .error-message,
    select:invalid + .error-message {
      display: block;
    }
    
    /* 3.51 Анимация для кнопок */
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    .btn-pulse {
      animation: pulse 2s infinite;
    }
    
    /* 3.52 Дополнительные стили для улучшения UX */
    .tooltip {
      position: relative;
      display: inline-block;
    }
    
    .tooltip .tooltiptext {
      visibility: hidden;
      width: 200px;
      background-color: var(--card-color);
      color: var(--text-color);
      text-align: center;
      border-radius: 6px;
      padding: 8px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 14px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
    
    /* 3.53 Подсказки для полей формы */
    .field-hint {
      font-size: 12px;
      color: rgba(255,255,255,0.6);
      margin-top: 5px;
    }
    
    /* 3.54 Улучшенный скроллбар */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: rgba(0,0,0,0.1);
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--primary-color);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: var(--secondary-color);
    }

    /* 3.55 Стили для натальной карты */
    .natal-chart-container {
      margin-top: 20px;
      background: var(--card-color);
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
    }

    .natal-chart {
      width: 100%;
      height: 300px;
      margin: 20px 0;
    }

    .planet-info {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
    }

    .planet-card {
      background: rgba(0,0,0,0.2);
      padding: 10px;
      border-radius: var(--border-radius);
      flex: 1 1 calc(33% - 10px);
      min-width: 120px;
    }

    .planet-card h4 {
      margin: 0 0 5px 0;
      color: var(--primary-color);
      display: flex;
      align-items: center;
      gap: 5px;
    }

    /* 3.56 Стили для транзитов */
    .transits-container {
      margin-top: 20px;
      background: var(--card-color);
      padding: 20px;
      border-radius: var(--border-radius);
    }

    .transit-item {
      display: flex;
      align-items: center;
      padding: 10px;
      border-bottom: 1px dashed rgba(255,255,255,0.1);
    }

    .transit-icon {
      font-size: 24px;
      margin-right: 15px;
      width: 30px;
      text-align: center;
    }

    .transit-content {
      flex: 1;
    }

    .transit-date {
      font-size: 12px;
      opacity: 0.7;
    }

    /* 3.57 Стили для лунного календаря */
    .moon-phase {
      text-align: center;
      margin: 20px 0;
    }

    .moon-icon {
      font-size: 50px;
      margin-bottom: 10px;
    }

    .moon-calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      margin-top: 15px;
    }

    .moon-day {
      text-align: center;
      padding: 5px;
      border-radius: 5px;
      background: rgba(0,0,0,0.1);
    }

    .moon-day.active {
      background: var(--primary-color);
      color: white;
    }

    /* 3.58 Стили для обучения */
    .learning-card {
      background: var(--card-color);
      padding: 15px;
      border-radius: var(--border-radius);
      margin-bottom: 15px;
    }

    .learning-card h3 {
      color: var(--primary-color);
      margin-top: 0;
    }

    .quiz-container {
      margin-top: 15px;
    }

    .quiz-question {
      font-weight: bold;
      margin-bottom: 10px;
    }

    .quiz-options {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .quiz-option {
      padding: 8px;
      border-radius: 5px;
      background: rgba(0,0,0,0.1);
      cursor: pointer;
      transition: background 0.2s;
    }

    .quiz-option:hover {
      background: rgba(0,0,0,0.2);
    }

    .quiz-option.correct {
      background: var(--success-color);
    }

    .quiz-option.incorrect {
      background: var(--error-color);
    }

    /* 3.59 Стили для совместимости */
    .compatibility-container {
      margin-top: 20px;
    }

    .compatibility-score {
      font-size: 24px;
      font-weight: bold;
      color: var(--primary-color);
      text-align: center;
      margin: 15px 0;
    }

    .compatibility-aspects {
      margin-top: 15px;
    }

    .aspect-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px dashed rgba(255,255,255,0.1);
    }

    /* 3.60 Стили для достижений */
    .achievements-container {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 15px;
    }

    .achievement {
      text-align: center;
      padding: 10px;
      border-radius: var(--border-radius);
      background: rgba(0,0,0,0.1);
    }

    .achievement.locked {
      opacity: 0.5;
    }

    .achievement-icon {
      font-size: 24px;
      margin-bottom: 5px;
    }

    .achievement-title {
      font-size: 12px;
    }
  </style>
</head>
<body>
  <!-- 4. Контейнер для звездного фона -->
  <div id="stars-container"></div>
  
  <!-- 5. Счетчик звезд -->
  <div class="stars-counter" id="starsCounter" title="Ваши звезды">
    <i class="fas fa-star"></i>
    <span id="starsCount">0</span>
  </div>
  
  <!-- 6. Главное меню -->
  <div id="mainMenu">
    <div class="logo-container" id="themeToggle" title="Сменить тему">
      <svg class="logo-svg" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <path id="star-path" d="M100,20 L123.5,70 L177.6,76.8 L137.8,113.9 L149.1,167.6 L100,142 L50.9,167.6 L62.2,113.9 L22.4,76.8 L76.5,70 Z" />
          <circle id="circle-path" cx="100" cy="100" r="80" />
        </defs>
      </svg>
      <div class="logo-text">ASTRODAMUS</div>
      <span id="themeIcon" style="margin-top: 10px; font-size: 20px; display: block;">
        <i class="fas fa-moon"></i>
      </span>
    </div>
    
    <!-- 7. Основные кнопки меню -->
    <div class="main-menu">
      <button id="profileBtn" class="btn" aria-label="Заполнить анкету">
        <i class="fas fa-user-edit"></i> Анкета
      </button>
      <button id="natalChartBtn" class="btn" aria-label="Натальная карта">
        <i class="fas fa-star-chart"></i> Натальная карта
      </button>
      <button id="dailyForecastBtn" class="btn" aria-label="Прогноз на день">
        <i class="fas fa-sun"></i> Прогноз на день
      </button>
      <button id="weeklyForecastBtn" class="btn" aria-label="Прогноз на неделю">
        <i class="fas fa-calendar-week"></i> Прогноз на неделю
      </button>
      <button id="monthlyForecastBtn" class="btn" aria-label="Прогноз на месяц">
        <i class="fas fa-calendar-alt"></i> Прогноз на месяц
      </button>
      <button id="transitsBtn" class="btn" aria-label="Текущие транзиты">
        <i class="fas fa-satellite"></i> Транзиты
      </button>
      <button id="moonBtn" class="btn" aria-label="Лунный календарь">
        <i class="fas fa-moon"></i> Лунный календарь
      </button>
      <button id="learningBtn" class="btn" aria-label="Обучение астрологии">
        <i class="fas fa-graduation-cap"></i> Обучение
      </button>
    </div>
    
    <!-- 8. Оверлей для бонусного сообщения -->
    <div class="overlay" id="overlay"></div>
    
    <!-- 9. Бонусное сообщение -->
    <div class="bonus-message" id="bonusMessage">
      <button class="close-bonus" id="closeBonusMessage" aria-label="Закрыть">
        <i class="fas fa-times"></i>
      </button>
      <h3><i class="fas fa-gift"></i> Ваш мини-бонус!</h3>
      <p id="bonusText"></p>
      <div class="stars-added" id="starsAdded" style="display: none;">
        <i class="fas fa-star"></i> +<span id="starsAddedCount">1</span> звезда
      </div>
      <button class="btn btn-primary" id="shareBonusBtn" style="margin-top: 15px; display: none;">
        <i class="fas fa-share-alt"></i> Поделиться бонусом
      </button>
    </div>
    
    <!-- 10. Кнопки внизу экрана -->
    <div class="bottom-buttons">
      <button id="bonusBtn" class="btn btn-warning" aria-label="Получить бонус">
        <i class="fas fa-envelope"></i> Получить бонус
      </button>
      <button id="shareAppBtn" class="btn btn-info" aria-label="Поделиться приложением">
        <i class="fas fa-share-alt"></i> Поделиться приложением
      </button>
    </div>
  </div>
  
  <!-- 11. Боковая панель для анкеты -->
  <div class="side-panel" id="profilePanel">
    <button class="close-panel" id="closeProfilePanel" aria-label="Закрыть панель">
      <i class="fas fa-times"></i>
    </button>
    
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <h2><i class="fas fa-user-edit"></i> Анкета</h2>
      <button id="editProfileBtn" class="btn btn-info" style="display: none;">
        <i class="fas fa-edit"></i> Редактировать
      </button>
    </div>
    
    <!-- 12. Прогресс-бар анкеты -->
    <div id="formProgressContainer" class="progress-container">
      <div class="progress-bar" id="formProgressBar" style="width: 33%"></div>
      <div class="progress-steps">
        <div class="step active" id="step1">Личные данные</div>
        <div class="step" id="step2">Астрология</div>
        <div class="step" id="step3">Интересы</div>
      </div>
    </div>
    
    <!-- 13. Форма анкеты -->
    <form id="astroForm" style="display: none;">
      <div class="form-step" id="step1Form">
        <div class="form-group">
          <label for="name"><i class="fas fa-user"></i>Имя:</label>
          <input type="text" id="name" name="name" required aria-required="true" minlength="2" maxlength="30" />
          <div class="error-message" id="name-error">Пожалуйста, введите ваше имя (от 2 до 30 символов)</div>
        </div>
        
        <div class="form-group">
          <label for="gender"><i class="fas fa-venus-mars"></i>Пол:</label>
          <select id="gender" name="gender" required aria-required="true">
            <option value="">Выберите</option>
            <option value="м">Мужской</option>
            <option value="ж">Женский</option>        
          </select>
          <div class="error-message" id="gender-error">Пожалуйста, выберите пол</div>
        </div>
        
        <button type="button" class="btn next-step" id="nextStep1">
          Далее <i class="fas fa-arrow-right"></i>
        </button>
      </div>
      
      <div class="form-step" id="step2Form" style="display: none;">
        <div class="form-group">
          <label for="birth_date"><i class="fas fa-calendar-day"></i>Дата рождения:</label>
          <input type="date" id="birth_date" name="birth_date" required aria-required="true" 
                 max="<?= date('Y-m-d') ?>" min="1900-01-01" />
          <div class="error-message" id="birth_date-error">Пожалуйста, введите корректную дату</div>
        </div>
        
        <div class="form-group">
          <label for="birth_time"><i class="fas fa-clock"></i>Время рождения (необязательно):</label>
          <input type="time" id="birth_time" name="birth_time" aria-describedby="timeHint" />
          <div class="field-hint" id="timeHint">Формат: чч:мм (24-часовой)</div>
        </div>
        
        <div class="form-group">
          <label for="birth_city"><i class="fas fa-city"></i>Город рождения:</label>
          <input type="text" id="birth_city" name="birth_city" required aria-required="true" 
                 minlength="2" maxlength="50" />
          <div class="error-message" id="birth_city-error">Пожалуйста, укажите город рождения (от 2 до 50 символов)</div>
        </div>
        
        <div class="form-group">
          <label for="zodiac_system"><i class="fas fa-globe"></i>Система зодиака:</label>
          <select id="zodiac_system" name="zodiac_system">
            <option value="tropical">Тропический (западный)</option>
            <option value="sidereal">Сидерический (ведический)</option>
          </select>
        </div>
        
        <div class="form-navigation">
          <button type="button" class="btn prev-step" id="prevStep2">
            <i class="fas fa-arrow-left"></i> Назад
          </button>
          <button type="button" class="btn next-step" id="nextStep2">
            Далее <i class="fas fa-arrow-right"></i>
          </button>
        </div>
      </div>
      
      <div class="form-step" id="step3Form" style="display: none;">
        <div class="form-group">
          <label for="interest"><i class="fas fa-star"></i>Основной интерес:</label>
          <select id="interest" name="interest" required aria-required="true">
            <option value="">Выберите</option>
            <option value="Любовь и отношения">Любовь и отношения</option>
            <option value="Карьера и бизнес">Карьера и бизнес</option>
            <option value="Финансы и инвестиции">Финансы и инвестиции</option>
            <option value="Здоровье и благополучие">Здоровье и благополучие</option>
            <option value="Семья и дети">Семья и дети</option>
            <option value="Личностный рост">Личностный рост</option>
            <option value="Творчество и вдохновение">Творчество и вдохновение</option>
            <option value="Путешествия и переезды">Путешествия и переезды</option>
          </select>
          <div class="error-message" id="interest-error">Пожалуйста, выберите интерес</div>
        </div>
        
        <div class="form-group">
          <label for="relationship"><i class="fas fa-heart"></i>Семейное положение:</label>
          <select id="relationship" name="relationship" required aria-required="true">
            <option value="">Выберите</option>
            <option value="В паре">В отношениях</option>
            <option value="Не в паре">Не в отношениях</option>
            <option value="В поиске">В поиске</option>
          </select>
          <div class="error-message" id="relationship-error">Пожалуйста, укажите семейное положение</div>
        </div>
        
        <div class="form-navigation">
          <button type="button" class="btn prev-step" id="prevStep3">
            <i class="fas fa-arrow-left"></i> Назад
          </button>
          <button type="submit" class="btn btn-success" id="saveProfileBtn">
            <i class="fas fa-save"></i> Сохранить анкету
          </button>
        </div>
      </div>
    </form>
    
    <!-- 14. Просмотр профиля -->
    <div class="profile-view" id="profileView">
      <h3><i class="fas fa-user-circle"></i> Ваши данные</h3>
      <div id="profileData"></div>
      
      <!-- 14.1 Реферальная ссылка -->
      <div class="ref-link" id="refLinkContainer" style="display: none;">
        <i class="fas fa-user-plus"></i> Пригласите друзей и получите 5 звезд за каждого!
        <div class="ref-link" id="refLink"></div>
      </div>
    </div>
  </div>
  
  <!-- 15. Панель прогноза -->
  <div class="side-panel" id="forecastPanel">
    <button class="close-panel" id="closeForecastPanel" aria-label="Закрыть панель">
      <i class="fas fa-times"></i>
    </button>
    <div class="forecast-container" id="forecastContainer">
      <div class="forecast-header">
        <h2 id="forecastTitle"><i class="fas fa-crystal-ball"></i> Ваш персональный астропрогноз</h2>
        <p id="forecastDate"></p>
      </div>
      
      <div class="forecast-content" id="forecastContent">
      </div>
      
      <div class="share-buttons">
        <button class="btn telegram-btn" id="shareTelegram" aria-label="Поделиться в Telegram">
          <i class="fab fa-telegram"></i> Telegram
        </button>
        <button class="btn whatsapp-btn" id="shareWhatsApp" aria-label="Поделиться в WhatsApp">
          <i class="fab fa-whatsapp"></i> WhatsApp
        </button>
        <button class="btn btn-success" id="saveForecastBtn" aria-label="Сохранить прогноз">
          <i class="fas fa-bookmark"></i> Сохранить
        </button>
      </div>
    </div>
  </div>

  <!-- 16. Панель натальной карты -->
  <div class="side-panel" id="natalChartPanel">
    <button class="close-panel" id="closeNatalChartPanel" aria-label="Закрыть панель">
      <i class="fas fa-times"></i>
    </button>
    
    <h2><i class="fas fa-star-chart"></i> Ваша натальная карта</h2>
    
    <div class="natal-chart-container">
      <div class="natal-chart">
        <canvas id="natalChartCanvas"></canvas>
      </div>
      
      <div class="planet-info" id="planetInfo">
        <!-- Информация о планетах будет загружена динамически -->
      </div>
      
      <div class="compatibility-container" id="compatibilitySection" style="display: none;">
        <h3><i class="fas fa-heart"></i> Совместимость</h3>
        <div id="compatibilityContent"></div>
        <button class="btn btn-info" id="addPartnerBtn">
          <i class="fas fa-user-plus"></i> Добавить партнера
        </button>
      </div>
    </div>
  </div>

  <!-- 17. Панель транзитов -->
  <div class="side-panel" id="transitsPanel">
    <button class="close-panel" id="closeTransitsPanel" aria-label="Закрыть панель">
      <i class="fas fa-times"></i>
    </button>
    
    <h2><i class="fas fa-satellite"></i> Текущие транзиты</h2>
    
    <div class="transits-container">
      <div id="currentTransits">
        <!-- Текущие транзиты будут загружены динамически -->
      </div>
      
      <div id="transitNotifications" style="margin-top: 20px;">
        <h3><i class="fas fa-bell"></i> Уведомления</h3>
        <div id="notificationsList"></div>
      </div>
    </div>
  </div>

  <!-- 18. Панель лунного календаря -->
  <div class="side-panel" id="moonPanel">
    <button class="close-panel" id="closeMoonPanel" aria-label="Закрыть панель">
      <i class="fas fa-times"></i>
    </button>
    
    <h2><i class="fas fa-moon"></i> Лунный календарь</h2>
    
    <div class="moon-phase">
      <div class="moon-icon" id="currentMoonPhaseIcon"></div>
      <h3 id="currentMoonPhase"></h3>
      <p id="moonPhaseDescription"></p>
    </div>
    
    <div class="moon-calendar" id="moonCalendar">
      <!-- Лунный календарь будет загружен динамически -->
    </div>
    
    <div class="moon-rituals" style="margin-top: 20px;">
      <h3><i class="fas fa-magic"></i> Рекомендации</h3>
      <div id="moonRituals"></div>
    </div>
  </div>

  <!-- 19. Панель обучения -->
  <div class="side-panel" id="learningPanel">
    <button class="close-panel" id="closeLearningPanel" aria-label="Закрыть панель">
      <i class="fas fa-times"></i>
    </button>
    
    <h2><i class="fas fa-graduation-cap"></i> Обучение астрологии</h2>
    
    <div id="learningContent">
      <!-- Контент обучения будет загружен динамически -->
    </div>
  </div>

  <!-- 20. Подключение библиотеки автодополнения -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.js"></script>
  
  <!-- 21. Основной JavaScript код -->
  <script>
    // 21.1 Инициализация WebApp Telegram
    const tg = window.Telegram.WebApp;
    if (tg) {
      tg.expand();
      tg.enableClosingConfirmation();
      tg.BackButton.onClick(() => hideAllPanels());
    }
    
    // 21.2 Основные элементы
    const mainMenu = document.getElementById('mainMenu');
    const profileBtn = document.getElementById('profileBtn');
    const natalChartBtn = document.getElementById('natalChartBtn');
    const dailyForecastBtn = document.getElementById('dailyForecastBtn');
    const weeklyForecastBtn = document.getElementById('weeklyForecastBtn');
    const monthlyForecastBtn = document.getElementById('monthlyForecastBtn');
    const transitsBtn = document.getElementById('transitsBtn');
    const moonBtn = document.getElementById('moonBtn');
    const learningBtn = document.getElementById('learningBtn');
    const shareAppBtn = document.getElementById('shareAppBtn');
    const bonusBtn = document.getElementById('bonusBtn');
    const bonusMessage = document.getElementById('bonusMessage');
    const bonusText = document.getElementById('bonusText');
    const closeBonusMessage = document.getElementById('closeBonusMessage');
    const overlay = document.getElementById('overlay');
    const themeToggle = document.getElementById('themeToggle');
    const starsCounter = document.getElementById('starsCounter');
    const starsCount = document.getElementById('starsCount');
    const starsAdded = document.getElementById('starsAdded');
    const starsAddedCount = document.getElementById('starsAddedCount');
    const refLinkContainer = document.getElementById('refLinkContainer');
    const refLink = document.getElementById('refLink');
    const shareBonusBtn = document.getElementById('shareBonusBtn');
    const saveForecastBtn = document.getElementById('saveForecastBtn');
    
    // 21.3 Панели
    const profilePanel = document.getElementById('profilePanel');
    const forecastPanel = document.getElementById('forecastPanel');
    const natalChartPanel = document.getElementById('natalChartPanel');
    const transitsPanel = document.getElementById('transitsPanel');
    const moonPanel = document.getElementById('moonPanel');
    const learningPanel = document.getElementById('learningPanel');
    
    // 21.4 Кнопки закрытия панелей
    const closeProfilePanel = document.getElementById('closeProfilePanel');
    const closeForecastPanel = document.getElementById('closeForecastPanel');
    const closeNatalChartPanel = document.getElementById('closeNatalChartPanel');
    const closeTransitsPanel = document.getElementById('closeTransitsPanel');
    const closeMoonPanel = document.getElementById('closeMoonPanel');
    const closeLearningPanel = document.getElementById('closeLearningPanel');
    
    // 21.5 Форма анкеты
    const profileForm = document.getElementById('astroForm');
    const saveProfileBtn = document.getElementById('saveProfileBtn');
    const profileView = document.getElementById('profileView');
    const profileData = document.getElementById('profileData');
    const editProfileBtn = document.getElementById('editProfileBtn');
    const formProgressContainer = document.getElementById('formProgressContainer');
    
    // 21.6 Прогноз
    const forecastContent = document.getElementById('forecastContent');
    const forecastDate = document.getElementById('forecastDate');
    const forecastTitle = document.getElementById('forecastTitle');
    
    // 21.7 Прогресс-бар анкеты
    const formProgressBar = document.getElementById('formProgressBar');
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const step3 = document.getElementById('step3');
    
    // 21.8 Шаги анкеты
    const step1Form = document.getElementById('step1Form');
    const step2Form = document.getElementById('step2Form');
    const step3Form = document.getElementById('step3Form');
    
    // 21.9 Навигация по шагам
    const nextStep1 = document.getElementById('nextStep1');
    const nextStep2 = document.getElementById('nextStep2');
    const prevStep2 = document.getElementById('prevStep2');
    const prevStep3 = document.getElementById('prevStep3');
    
    // 21.10 Натальная карта
    const natalChartCanvas = document.getElementById('natalChartCanvas');
    const planetInfo = document.getElementById('planetInfo');
    const compatibilitySection = document.getElementById('compatibilitySection');
    const compatibilityContent = document.getElementById('compatibilityContent');
    const addPartnerBtn = document.getElementById('addPartnerBtn');
    
    // 21.11 Транзиты
    const currentTransits = document.getElementById('currentTransits');
    const notificationsList = document.getElementById('notificationsList');
    
    // 21.12 Лунный календарь
    const currentMoonPhaseIcon = document.getElementById('currentMoonPhaseIcon');
    const currentMoonPhase = document.getElementById('currentMoonPhase');
    const moonPhaseDescription = document.getElementById('moonPhaseDescription');
    const moonCalendar = document.getElementById('moonCalendar');
    const moonRituals = document.getElementById('moonRituals');
    
    // 21.13 Обучение
    const learningContent = document.getElementById('learningContent');
    
    // 21.14 Мотивирующие фразы для бонуса
    const bonusPhrases = [
      "Солнышко, сегодня твой день! Звезды сложились в твою пользу — действуй смело!",
      "Родной человек, сегодня Вселенная шепчет: ты сильнее, чем думаешь! Верь в себя!",
      "Любимое сердце, сегодняшний день — твой шанс! Не упусти возможность сделать шаг к мечте!",
      "Близкий мой, звезды говорят — сегодня день маленьких чудес. Будь открыт к сюрпризам!",
      "Теплый свет, твоя энергия сегодня на высоте! Используй этот день для важных дел!",
      "Сокровище, сегодня идеальный момент для новых начинаний. Дерзай!",
      "Радость моя, сегодня твоя интуиция особенно сильна. Доверься внутреннему голосу!",
      "Ангелочек, помни — даже маленькие шаги приводят к большим целям. Ты молодец!",
      "Звездочка, сегодня день магии и возможностей. Верь в чудеса — они рядом!",
      "Солнышко, твои мечты ближе, чем кажется. Продолжай идти — ты на верном пути!"
    ];
    
    // 21.15 Время последнего бонуса
    const BONUS_COOLDOWN = 3 * 60 * 60 * 1000; // 3 часа в миллисекундах
    let lastBonusTime = parseInt(localStorage.getItem('lastBonusTime')) || 0;
    let currentForecast = null;
    let natalChart = null;
    
    // 21.16 Создание звездного фона
    function createStars() {
      const starsCount = 200;
      const containerWidth = window.innerWidth;
      const containerHeight = window.innerHeight;
      
      for (let i = 0; i < starsCount; i++) {
        const star = document.createElement('div');
        star.classList.add('star');
        
        const size = Math.random() * 3;
        const x = Math.random() * containerWidth;
        const y = Math.random() * containerHeight;
        const duration = 2 + Math.random() * 3 + 's';
        const delay = Math.random() * 5 + 's';
        
        star.style.width = `${size}px`;
        star.style.height = `${size}px`;
        star.style.left = `${x}px`;
        star.style.top = `${y}px`;
        star.style.setProperty('--duration', duration);
        star.style.animationDelay = delay;
        
        document.getElementById('stars-container').appendChild(star);
      }
    }
    
    // 21.17 Определение знака зодиака по дате рождения
    function getZodiacSign(dateString, system = 'tropical') {
      if (!dateString) return '';
      
      const date = new Date(dateString);
      const day = date.getDate();
      const month = date.getMonth() + 1;
      
      // Тропический зодиак (западная астрология)
      if (system === 'tropical') {
        if ((month == 3 && day >= 21) || (month == 4 && day <= 19)) return 'Овен';
        if ((month == 4 && day >= 20) || (month == 5 && day <= 20)) return 'Телец';
        if ((month == 5 && day >= 21) || (month == 6 && day <= 20)) return 'Близнецы';
        if ((month == 6 && day >= 21) || (month == 7 && day <= 22)) return 'Рак';
        if ((month == 7 && day >= 23) || (month == 8 && day <= 22)) return 'Лев';
        if ((month == 8 && day >= 23) || (month == 9 && day <= 22)) return 'Дева';
        if ((month == 9 && day >= 23) || (month == 10 && day <= 22)) return 'Весы';
        if ((month == 10 && day >= 23) || (month == 11 && day <= 21)) return 'Скорпион';
        if ((month == 11 && day >= 22) || (month == 12 && day <= 21)) return 'Стрелец';
        if ((month == 12 && day >= 22) || (month == 1 && day <= 19)) return 'Козерог';
        if ((month == 1 && day >= 20) || (month == 2 && day <= 18)) return 'Водолей';
        if ((month == 2 && day >= 19) || (month == 3 && day <= 20)) return 'Рыбы';
      }
      // Сидерический зодиак (ведическая астрология) - с поправкой на айанамшу (~24°)
      else {
        if ((month == 4 && day >= 14) || (month == 5 && day <= 14)) return 'Овен';
        if ((month == 5 && day >= 15) || (month == 6 && day <= 14)) return 'Телец';
        if ((month == 6 && day >= 15) || (month == 7 && day <= 14)) return 'Близнецы';
        if ((month == 7 && day >= 15) || (month == 8 && day <= 16)) return 'Рак';
        if ((month == 8 && day >= 17) || (month == 9 && day <= 16)) return 'Лев';
        if ((month == 9 && day >= 17) || (month == 10 && day <= 16)) return 'Дева';
        if ((month == 10 && day >= 17) || (month == 11 && day <= 15)) return 'Весы';
        if ((month == 11 && day >= 16) || (month == 12 && day <= 15)) return 'Скорпион';
        if ((month == 12 && day >= 16) || (month == 1 && day <= 14)) return 'Стрелец';
        if ((month == 1 && day >= 15) || (month == 2 && day <= 12)) return 'Козерог';
        if ((month == 2 && day >= 13) || (month == 3 && day <= 14)) return 'Водолей';
        if ((month == 3 && day >= 15) || (month == 4 && day <= 13)) return 'Рыбы';
      }
      
      return '';
    }
    
    // 21.18 Получение гороскопа через OpenRouter API
    async function getHoroscope(zodiacSign, period = 'today') {
      try {
        // Преобразуем русское название знака в английское для API
        const zodiacMap = {
          'Овен': 'Aries',
          'Телец': 'Taurus',
          'Близнецы': 'Gemini',
          'Рак': 'Cancer',
          'Лев': 'Leo',
          'Дева': 'Virgo',
          'Весы': 'Libra',
          'Скорпион': 'Scorpio',
          'Стрелец': 'Sagittarius',
          'Козерог': 'Capricorn',
          'Водолей': 'Aquarius',
          'Рыбы': 'Pisces'
        };
        
        const sign = zodiacMap[zodiacSign] || 'Aries';
        const periodMap = {
          'today': 'today',
          'day': 'today',
          'week': 'week',
          'month': 'month',
          'year': 'year'
        };
        
        const periodKey = periodMap[period] || 'today';
        
        // Используем OpenRouter API для получения прогноза
        const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer 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',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            model: "openai/gpt-3.5-turbo",
            messages: [
              {
                role: "user",
                content: `Напиши астрологический прогноз для знака ${zodiacSign} на ${periodKey === 'today' ? 'сегодня' : periodKey === 'week' ? 'неделю' : periodKey === 'month' ? 'месяц' : 'год'}. 
                Будь позитивным и мотивирующим, используй эмодзи. Ответь на русском языке.`
              }
            ]
          })
        });

        if (!response.ok) {
          throw new Error('Ошибка запроса к API');
        }

        const data = await response.json();
        const forecast = data.choices?.[0]?.message?.content || 'Описание недоступно';
        
        return {
          description: forecast,
          date: new Date().toLocaleDateString('ru-RU'),
          zodiacSign: zodiacSign,
          period: periodKey
        };
      } catch (error) {
        console.error('Ошибка:', error);
        // Возвращаем локально сохраненные прогнозы, если API недоступно
        return getLocalHoroscope(zodiacSign, period);
      }
    }

    // 21.19 Локальные прогнозы (используются, если API недоступно)
    function getLocalHoroscope(zodiacSign, period) {
      const forecasts = {
        'Овен': {
          today: "🔥 Сегодня звезды благоволят Овнам! Это отличный день для новых начинаний и смелых решений. Ваша энергия на высоте - используйте это!",
          week: "🚀 На этой неделе Овнам стоит проявить инициативу. Возможны неожиданные повороты событий, но они приведут к хорошим результатам.",
          month: "🌈 Этот месяц принесет Овнам важные изменения. Будьте готовы к новым возможностям и не бойтесь выходить из зоны комфорта!",
          year: "✨ Этот год будет для Овнов временем больших перемен. Ваша энергия и энтузиазм помогут преодолеть любые препятствия!"
        },
        'Телец': {
          today: "💎 Сегодня Тельцам стоит проявить терпение. Избегайте поспешных решений - лучшее придет к вам само.",
          week: "💰 На этой неделе Тельцы могут рассчитывать на стабильность. Хорошее время для финансовых операций и планирования бюджета.",
          month: "🌱 Этот месяц будет продуктивным для Тельцов. Сосредоточьтесь на долгосрочных целях - ваши усилия окупятся!",
          year: "🏛 Год стабильности и роста для Тельцов. Постепенные, но уверенные шаги приведут к значительным результатам."
        },
        'Близнецы': {
          today: "💡 Сегодня Близнецам стоит прислушаться к своей интуиции. Новые идеи могут привести к неожиданным возможностям.",
          week: "📚 На этой неделе Близнецам будет полезно учиться чему-то новому. Знания, полученные сейчас, пригодятся в будущем.",
          month: "🗣 Этот месяц хорош для общения. Близнецы смогут наладить полезные контакты и укрепить существующие связи.",
          year: "🌍 Год расширения горизонтов для Близнецов. Путешествия, обучение и новые знакомства обогатят ваш опыт."
        },
        'Рак': {
          today: "🏡 Сегодня Ракам стоит уделить внимание дому и семье. Маленькие радости принесут большое удовлетворение.",
          week: "💖 На этой неделе Раки будут особенно чувствительны к эмоциям окружающих. Проявите заботу о близких.",
          month: "🌊 Этот месяц принесет Ракам эмоциональную стабильность. Хорошее время для решения накопившихся вопросов.",
          year: "❤️ Год глубоких эмоциональных переживаний и семейных ценностей для Раков. Ваша интуиция будет особенно сильна."
        },
        'Лев': {
          today: "👑 Сегодня Львы будут в центре внимания! Используйте этот день для важных встреч и презентаций.",
          week: "✨ На этой неделе Львы почувствуют прилив творческой энергии. Хорошее время для реализации амбициозных планов.",
          month: "🌟 Этот месяц принесет Львам признание их заслуг. Ваши таланты будут замечены и оценены по достоинству.",
          year: "🎭 Год творчества и самовыражения для Львов. Ваша харизма и лидерские качества приведут к успеху."
        },
        'Дева': {
          today: "📝 Сегодня Девам стоит заняться планированием. Детальный анализ поможет избежать ошибок в будущем.",
          week: "🔍 На этой неделе Девам будет полезно разобраться в текущих делах. Организация - ваш ключ к успеху.",
          month: "🌿 Этот месяц хорош для улучшения здоровья и привычек. Маленькие изменения приведут к большим результатам.",
          year: "📊 Год эффективности и продуктивности для Дев. Ваше внимание к деталям поможет достичь выдающихся результатов."
        },
        'Весы': {
          today: "⚖️ Сегодня Весам важно найти баланс между работой и отдыхом. Не перегружайте себя.",
          week: "💑 На этой неделе Весы смогут укрепить личные отношения. Хорошее время для романтических жестов.",
          month: "🎨 Этот месяц принесет Весам вдохновение. Творческие проекты будут особенно успешными.",
          year: "🤝 Год гармонии и партнерства для Весов. Ваша дипломатичность поможет разрешить любые конфликты."
        },
        'Скорпион': {
          today: "🦂 Сегодня Скорпионам стоит довериться своей интуиции. Она подскажет верное решение.",
          week: "💪 На этой неделе Скорпионы почувствуют прилив сил. Хорошее время для решения сложных задач.",
          month: "🔄 Этот месяц принесет Скорпионам важные перемены. Будьте готовы к новому этапу в жизни.",
          year: "🔥 Год трансформации и возрождения для Скорпионов. Глубокие изменения приведут к личностному росту."
        },
        'Стрелец': {
          today: "🏹 Сегодня Стрельцы будут полны энергии. Используйте этот день для активных действий.",
          week: "🌍 На этой неделе Стрельцы могут получить интересные предложения, связанные с путешествиями или обучением.",
          month: "🎯 Этот месяц хорош для постановки новых целей. Ваш оптимизм поможет достичь желаемого.",
          year: "✈️ Год приключений и расширения горизонтов для Стрельцов. Путешествия и новые знания обогатят ваш опыт."
        },
        'Козерог': {
          today: "🏔 Сегодня Козерогам стоит сосредоточиться на карьере. Ваши усилия будут замечены руководством.",
          week: "📈 На этой неделе Козероги смогут продвинуться по карьерной лестнице. Проявите инициативу.",
          month: "💼 Этот месяц принесет Козерогам финансовую стабильность. Хорошее время для инвестиций.",
          year: "🏆 Год карьерных достижений и признания для Козерогов. Ваша дисциплина и упорство будут вознаграждены."
        },
        'Водолей': {
          today: "💡 Сегодня Водолеи будут полны оригинальных идей. Делитесь ими с окружающими!",
          week: "👥 На этой неделе Водолеи смогут найти единомышленников. Коллективная работа принесет успех.",
          month: "🚀 Этот месяц принесет Водолеям неожиданные возможности. Будьте открыты для нового.",
          year: "🌐 Год инноваций и социальных связей для Водолеев. Ваши идеи могут изменить мир к лучшему."
        },
        'Рыбы': {
          today: "🌊 Сегодня Рыбам стоит прислушаться к своим чувствам. Творчество принесет удовлетворение.",
          week: "💭 На этой неделе Рыбы будут особенно проницательны. Доверяйте своим предчувствиям.",
          month: "🌙 Этот месяц хорош для духовного роста и самопознания. Найдите время для размышлений.",
          year: "🧘‍♂️ Год духовного пробуждения и творчества для Рыб. Ваша чувствительность и интуиция будут вашими проводниками."
        }
      };

      const periodMap = {
        'today': 'today',
        'day': 'today',
        'week': 'week',
        'month': 'month',
        'year': 'year'
      };

      const periodKey = periodMap[period] || 'today';
      const defaultForecast = "✨ Сегодня благоприятный день. Прислушивайтесь к своей интуиции и верьте в лучшее!";

      return {
        description: forecasts[zodiacSign]?.[periodKey] || defaultForecast,
        date: new Date().toLocaleDateString('ru-RU'),
        zodiacSign: zodiacSign,
        period: periodKey
      };
    }

    // 21.20 Генерация натальной карты
    function generateNatalChart(data) {
      if (!data || !data.birth_date) {
        return '<p>Пожалуйста, заполните данные о рождении в анкете.</p>';
      }

      const zodiacSign = getZodiacSign(data.birth_date, data.zodiac_system || 'tropical');
      
      // Создаем фиктивные данные для визуализации
      const planets = [
        { name: 'Солнце', sign: zodiacSign, house: Math.floor(Math.random() * 12) + 1, degree: Math.floor(Math.random() * 30) },
        { name: 'Луна', sign: getRandomSign(zodiacSign), house: Math.floor(Math.random() * 12) + 1, degree: Math.floor(Math.random() * 30) },
        { name: 'Меркурий', sign: getRandomSign(zodiacSign), house: Math.floor(Math.random() * 12) + 1, degree: Math.floor(Math.random() * 30) },
        { name: 'Венера', sign: getRandomSign(zodiacSign), house: Math.floor(Math.random() * 12) + 1, degree: Math.floor(Math.random() * 30) },
        { name: 'Марс', sign: getRandomSign(zodiacSign), house: Math.floor(Math.random() * 12) + 1, degree: Math.floor(Math.random() * 30) },
        { name: 'Юпитер', sign: getRandomSign(zodiacSign), house: Math.floor(Math.random() * 12) + 1, degree: Math.floor(Math.random() * 30) },
        { name: 'Сатурн', sign: getRandomSign(zodiacSign), house: Math.floor(Math.random() * 12) + 1, degree: Math.floor(Math.random() * 30) },
        { name: 'Уран', sign: getRandomSign(zodiacSign), house: Math.floor(Math.random() * 12) + 1, degree: Math.floor(Math.random() * 30) },
        { name: 'Нептун', sign: getRandomSign(zodiacSign), house: Math.floor(Math.random() * 12) + 1, degree: Math.floor(Math.random() * 30) },
        { name: 'Плутон', sign: getRandomSign(zodiacSign), house: Math.floor(Math.random() * 12) + 1, degree: Math.floor(Math.random() * 30) },
        { name: 'Асцендент', sign: getRandomSign(zodiacSign), house: 1, degree: Math.floor(Math.random() * 30) }
      ];

      // Создаем HTML для информации о планетах
      let planetHTML = '';
      planets.forEach(planet => {
        planetHTML += `
          <div class="planet-card">
            <h4><i class="fas fa-${getPlanetIcon(planet.name)}"></i> ${planet.name}</h4>
            <p>Знак: ${planet.sign}</p>
            <p>Дом: ${planet.house}</p>
            <p>Градус: ${planet.degree}°</p>
          </div>
        `;
      });

      planetInfo.innerHTML = planetHTML;

      // Создаем круговую диаграмму для визуализации
      const ctx = natalChartCanvas.getContext('2d');
      
      if (natalChart) {
        natalChart.destroy();
      }

      natalChart = new Chart(ctx, {
        type: 'polarArea',
        data: {
          labels: planets.map(p => p.name),
          datasets: [{
            data: planets.map(p => p.degree),
            backgroundColor: [
              '#FFCE56', '#FF6384', '#36A2EB', '#4BC0C0', '#9966FF',
              '#FF9F40', '#8AC24A', '#FF5722', '#607D8B', '#9C27B0',
              '#E91E63'
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const planet = planets[context.dataIndex];
                  return `${planet.name}: ${planet.sign} (${planet.degree}°)`;
                }
              }
            }
          }
        }
      });

      // Показываем раздел совместимости, если есть данные партнера
      if (localStorage.getItem('partnerData')) {
        compatibilitySection.style.display = 'block';
        generateCompatibilityReport(data, JSON.parse(localStorage.getItem('partnerData')));
      } else {
        compatibilitySection.style.display = 'none';
      }

      return planets;
    }

    // 21.21 Генерация отчета о совместимости
    function generateCompatibilityReport(userData, partnerData) {
      const userSign = getZodiacSign(userData.birth_date, userData.zodiac_system || 'tropical');
      const partnerSign = getZodiacSign(partnerData.birth_date, partnerData.zodiac_system || 'tropical');
      
      // Функция для определения совместимости знаков
      function getCompatibility(sign1, sign2) {
        const elements = {
          'Овен': 'fire', 'Лев': 'fire', 'Стрелец': 'fire',
          'Телец': 'earth', 'Дева': 'earth', 'Козерог': 'earth',
          'Близнецы': 'air', 'Весы': 'air', 'Водолей': 'air',
          'Рак': 'water', 'Скорпион': 'water', 'Рыбы': 'water'
        };
        
        const element1 = elements[sign1];
        const element2 = elements[sign2];
        
        if (element1 === element2) return 80; // Хорошая совместимость
        if (
          (element1 === 'fire' && element2 === 'air') ||
          (element1 === 'air' && element2 === 'fire') ||
          (element1 === 'water' && element2 === 'earth') ||
          (element1 === 'earth' && element2 === 'water')
        ) return 70; // Средняя совместимость
        
        return 50; // Низкая совместимость
      }
      
      const compatibilityScore = getCompatibility(userSign, partnerSign);
      
      let compatibilityHTML = `
        <div class="compatibility-score">
          Совместимость: ${compatibilityScore}%
        </div>
        <p>${userSign} (Вы) и ${partnerSign} (Партнер)</p>
        <div class="compatibility-aspects">
          <h4>Ключевые аспекты:</h4>
      `;
      
      // Генерируем случайные аспекты для примера
      const aspects = [
        { name: 'Солнце-Луна', description: 'Гармония эмоций и воли' },
        { name: 'Венера-Марс', description: 'Сексуальная совместимость' },
        { name: 'Меркурий-Меркурий', description: 'Легкость общения' }
      ];
      
      aspects.forEach(aspect => {
        compatibilityHTML += `
          <div class="aspect-item">
            <span>${aspect.name}</span>
            <span>${aspect.description}</span>
          </div>
        `;
      });
      
      compatibilityHTML += `</div>`;
      compatibilityContent.innerHTML = compatibilityHTML;
      
      return compatibilityScore;
    }

    // 21.22 Генерация данных о транзитах
    function generateTransits() {
      const currentDate = new Date();
      const transits = [
        {
          planet: 'Меркурий',
          description: 'Меркурий в прямом движении - хорошее время для коммуникации и принятия решений',
          date: 'Сегодня',
          icon: 'fa-comments'
        },
        {
          planet: 'Венера',
          description: 'Венера в Тельце - благоприятный период для любви и финансов',
          date: 'До ' + new Date(currentDate.getTime() + 7 * 24 * 60 * 60 * 1000).toLocaleDateString('ru-RU'),
          icon: 'fa-heart'
        },
        {
          planet: 'Марс',
          description: 'Марс в Близнецах - энергия направлена на обучение и общение',
          date: 'До ' + new Date(currentDate.getTime() + 14 * 24 * 60 * 60 * 1000).toLocaleDateString('ru-RU'),
          icon: 'fa-bolt'
        }
      ];
      
      // Добавляем уведомления о важных астрологических событиях
      const notifications = [
        {
          title: 'Новолуние',
          date: new Date(currentDate.getTime() + 3 * 24 * 60 * 60 * 1000).toLocaleDateString('ru-RU'),
          description: 'Идеальное время для новых начинаний и постановки целей',
          icon: 'fa-moon'
        },
        {
          title: 'Ретроградный Меркурий',
          date: new Date(currentDate.getTime() + 10 * 24 * 60 * 60 * 1000).toLocaleDateString('ru-RU'),
          description: 'Будьте осторожны с подписанием договоров и покупкой техники',
          icon: 'fa-undo'
        }
      ];
      
      // Отображаем транзиты
      let transitsHTML = '';
      transits.forEach(transit => {
        transitsHTML += `
          <div class="transit-item">
            <div class="transit-icon">
              <i class="fas ${transit.icon}"></i>
            </div>
            <div class="transit-content">
              <h4>${transit.planet}</h4>
              <p>${transit.description}</p>
              <div class="transit-date">${transit.date}</div>
            </div>
          </div>
        `;
      });
      
      currentTransits.innerHTML = transitsHTML;
      
      // Отображаем уведомления
      let notificationsHTML = '';
      notifications.forEach(notification => {
        notificationsHTML += `
          <div class="transit-item">
            <div class="transit-icon">
              <i class="fas ${notification.icon}"></i>
            </div>
            <div class="transit-content">
              <h4>${notification.title}</h4>
              <p>${notification.description}</p>
              <div class="transit-date">${notification.date}</div>
            </div>
          </div>
        `;
      });
      
      notificationsList.innerHTML = notificationsHTML;
      
      return { transits, notifications };
    }

    // 21.23 Генерация лунного календаря
    function generateMoonCalendar() {
      const moonPhases = [
        { name: 'Новолуние', icon: 'fa-circle', description: 'Время новых начинаний и постановки целей' },
        { name: 'Растущая Луна', icon: 'fa-adjust', description: 'Период роста и накопления энергии' },
        { name: 'Полнолуние', icon: 'fa-circle', description: 'Пик энергии, время реализации планов' },
        { name: 'Убывающая Луна', icon: 'fa-adjust', description: 'Период завершения дел и избавления от ненужного' }
      ];
      
      const currentPhase = moonPhases[Math.floor(Math.random() * moonPhases.length)];
      
      currentMoonPhaseIcon.innerHTML = `<i class="fas ${currentPhase.icon}"></i>`;
      currentMoonPhase.textContent = currentPhase.name;
      moonPhaseDescription.textContent = currentPhase.description;
      
      // Генерируем календарь на 7 дней
      let calendarHTML = '';
      const today = new Date();
      
      for (let i = 0; i < 7; i++) {
        const date = new Date(today.getTime() + i * 24 * 60 * 60 * 1000);
        const dayName = date.toLocaleDateString('ru-RU', { weekday: 'short' });
        const dayNumber = date.getDate();
        const isActive = i === 0;
        
        calendarHTML += `
          <div class="moon-day ${isActive ? 'active' : ''}">
            <div>${dayName}</div>
            <div>${dayNumber}</div>
          </div>
        `;
      }
      
      moonCalendar.innerHTML = calendarHTML;
      
      // Генерируем рекомендации по фазам луны
      let ritualsHTML = '';
      
      if (currentPhase.name === 'Новолуние') {
        ritualsHTML = `
          <p>🌑 <strong>Ритуалы на Новолуние:</strong></p>
          <ul>
            <li>Запишите свои цели и желания</li>
            <li>Начните новый проект</li>
            <li>Посадите растения (для роста)</li>
          </ul>
        `;
      } else if (currentPhase.name === 'Растущая Луна') {
        ritualsHTML = `
          <p>🌒 <strong>Ритуалы на Растущую Луну:</strong></p>
          <ul>
            <li>Привлекайте богатство и успех</li>
            <li>Занимайтесь саморазвитием</li>
            <li>Укрепляйте здоровье</li>
          </ul>
        `;
      } else if (currentPhase.name === 'Полнолуние') {
        ritualsHTML = `
          <p>🌕 <strong>Ритуалы на Полнолуние:</strong></p>
          <ul>
            <li>Проводите очищающие практики</li>
            <li>Гадайте и загадывайте желания</li>
            <li>Завершайте начатые дела</li>
          </ul>
        `;
      } else {
        ritualsHTML = `
          <p>🌘 <strong>Ритуалы на Убывающую Луну:</strong></p>
          <ul>
            <li>Избавляйтесь от вредных привычек</li>
            <li>Проводите уборку и очищение</li>
            <li>Завершайте отношения, которые себя изжили</li>
          </ul>
        `;
      }
      
      moonRituals.innerHTML = ritualsHTML;
      
      return currentPhase;
    }

    // 21.24 Генерация обучающего контента
    function generateLearningContent() {
      const topics = [
        {
          title: 'Основы астрологии',
          content: 'Астрология - это язык символов, описывающий взаимосвязь между движениями небесных тел и событиями на Земле.',
          quiz: {
            question: 'Что изучает астрология?',
            options: [
              'Движение небесных тел и их влияние на Землю',
              'Только положение Солнца в момент рождения',
              'Только предсказание будущего',
              'Ничего из перечисленного'
            ],
            correct: 0
          }
        },
        {
          title: 'Знаки зодиака',
          content: '12 знаков зодиака представляют собой 12 секторов эклиптики, каждый из которых имеет свои характеристики.',
          quiz: {
            question: 'Сколько знаков зодиака в западной астрологии?',
            options: ['10', '12', '13', '8'],
            correct: 1
          }
        },
        {
          title: 'Планеты в астрологии',
          content: 'Каждая планета в астрологии символизирует определенные энергии и аспекты жизни. Солнце - это наша сущность, Луна - эмоции, Меркурий - коммуникация и т.д.',
          quiz: {
            question: 'Какая планета отвечает за коммуникацию?',
            options: ['Венера', 'Марс', 'Меркурий', 'Юпитер'],
            correct: 2
          }
        },
        {
          title: 'Дома гороскопа',
          content: '12 домов гороскопа представляют разные сферы жизни. Первый дом - личность, второй - финансы, третий - общение и т.д.',
          quiz: {
            question: 'Какой дом отвечает за карьеру?',
            options: ['4-й дом', '7-й дом', '10-й дом', '12-й дом'],
            correct: 2
          }
        },
        {
          title: 'Аспекты планет',
          content: 'Аспекты - это угловые расстояния между планетами, которые показывают, как они взаимодействуют. Основные аспекты: соединение, секстиль, квадрат, тригон, оппозиция.',
          quiz: {
            question: 'Какой аспект считается гармоничным?',
            options: ['Квадрат', 'Оппозиция', 'Тригон', 'Соединение'],
            correct: 2
          }
        }
      ];
      
      let learningHTML = '';
      
      topics.forEach((topic, index) => {
        learningHTML += `
          <div class="learning-card">
            <h3>${topic.title}</h3>
            <p>${topic.content}</p>
            
            <div class="quiz-container" id="quiz-${index}" style="display: none;">
              <div class="quiz-question">${topic.quiz.question}</div>
              <div class="quiz-options">
                ${topic.quiz.options.map((option, i) => `
                  <div class="quiz-option" data-quiz="${index}" data-option="${i}">${option}</div>
                `).join('')}
              </div>
            </div>
            
            <button class="btn btn-info quiz-toggle" data-quiz="${index}" style="margin-top: 10px;">
              <i class="fas fa-question-circle"></i> Проверить знания
            </button>
          </div>
        `;
      });
      
      learningContent.innerHTML = learningHTML;
      
      // Добавляем обработчики для квизов
      document.querySelectorAll('.quiz-toggle').forEach(button => {
        button.addEventListener('click', function() {
          const quizId = this.getAttribute('data-quiz');
          const quizElement = document.getElementById(`quiz-${quizId}`);
          
          if (quizElement.style.display === 'none') {
            quizElement.style.display = 'block';
            this.innerHTML = '<i class="fas fa-eye-slash"></i> Скрыть тест';
          } else {
            quizElement.style.display = 'none';
            this.innerHTML = '<i class="fas fa-question-circle"></i> Проверить знания';
          }
        });
      });
      
      document.querySelectorAll('.quiz-option').forEach(option => {
        option.addEventListener('click', function() {
          const quizId = this.getAttribute('data-quiz');
          const selectedOption = this.getAttribute('data-option');
          const correctOption = topics[quizId].quiz.correct;
          
          // Сбрасываем все стили
          document.querySelectorAll(`[data-quiz="${quizId}"]`).forEach(el => {
            el.classList.remove('correct', 'incorrect');
          });
          
          if (parseInt(selectedOption) === correctOption) {
            this.classList.add('correct');
            showNotification('Правильно!', 'success');
            addStars(1, 'правильный ответ в тесте');
          } else {
            this.classList.add('incorrect');
            showNotification('Неправильно, попробуйте еще раз', 'error');
          }
        });
      });
      
      return topics;
    }

    // 21.25 Вспомогательные функции для астрологии
    function getRandomSign(currentSign) {
      const signs = ['Овен', 'Телец', 'Близнецы', 'Рак', 'Лев', 'Дева', 'Весы', 'Скорпион', 'Стрелец', 'Козерог', 'Водолей', 'Рыбы'];
      let randomSign = signs[Math.floor(Math.random() * signs.length)];
      
      // Убедимся, что знак не совпадает с текущим
      while (randomSign === currentSign) {
        randomSign = signs[Math.floor(Math.random() * signs.length)];
      }
      
      return randomSign;
    }

    function getPlanetIcon(planetName) {
      const icons = {
        'Солнце': 'sun',
        'Луна': 'moon',
        'Меркурий': 'comment-alt',
        'Венера': 'venus',
        'Марс': 'mars',
        'Юпитер': 'expand',
        'Сатурн': 'ring',
        'Уран': 'atom',
        'Нептун': 'water',
        'Плутон': 'meteor',
        'Асцендент': 'arrow-up'
      };
      
      return icons[planetName] || 'star';
    }

    // 21.26 Показать боковую панель
    function showPanel(panel) {
      document.querySelectorAll('.side-panel').forEach(p => {
        p.classList.remove('active');
      });
      panel.classList.add('active');
      document.body.classList.add('panel-open');
      
      // Показываем кнопку "Назад" в Telegram
      if (tg && tg.BackButton) {
        tg.BackButton.show();
      }
      
      // Начисляем звезды за посещение раздела
      if (panel === profilePanel) {
        addStars(1, 'Посещение анкеты');
      } else if (panel === forecastPanel) {
        addStars(2, 'Просмотр прогноза');
      } else if (panel === natalChartPanel) {
        const savedData = localStorage.getItem('astroProfileData');
        if (savedData) {
          generateNatalChart(JSON.parse(savedData));
          addStars(3, 'Просмотр натальной карты');
        } else {
          showNotification('Пожалуйста, сначала заполните анкету', 'error');
          showPanel(profilePanel);
          return;
        }
      } else if (panel === transitsPanel) {
        generateTransits();
        addStars(2, 'Просмотр транзитов');
      } else if (panel === moonPanel) {
        generateMoonCalendar();
        addStars(2, 'Просмотр лунного календаря');
      } else if (panel === learningPanel) {
        generateLearningContent();
        addStars(1, 'Изучение астрологии');
      }
    }
    
    // 21.27 Скрыть все боковые панели
    function hideAllPanels() {
      document.querySelectorAll('.side-panel').forEach(panel => {
        panel.classList.remove('active');
      });
      document.body.classList.remove('panel-open');
      
      // Скрываем кнопку "Назад" в Telegram
      if (tg && tg.BackButton) {
        tg.BackButton.hide();
      }
    }
    
    // 21.28 Обновление прогресс-бара анкеты
    function updateProgress(currentStep) {
      const progress = (currentStep / 3) * 100;
      formProgressBar.style.width = `${progress}%`;
      
      step1.classList.remove('active', 'completed');
      step2.classList.remove('active', 'completed');
      step3.classList.remove('active', 'completed');
      
      if (currentStep >= 1) step1.classList.add('completed');
      if (currentStep >= 2) step2.classList.add('completed');
      if (currentStep >= 3) step3.classList.add('completed');
      
      document.getElementById(`step${currentStep}`).classList.add('active');
    }
    
    // 21.29 Переход к следующему шагу анкеты
    function goToNextStep(currentStep, nextStep) {
      const currentForm = document.getElementById(`step${currentStep}Form`);
      const inputs = currentForm.querySelectorAll('input, select');

      for (let field of inputs) {
        if (!field.checkValidity()) {
          field.reportValidity();
          return;
        }
      }

      currentForm.style.display = 'none';
      document.getElementById(`step${nextStep}Form`).style.display = 'block';
      updateProgress(nextStep);
      profilePanel.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // 21.30 Переход к предыдущему шагу анкеты
    function goToPrevStep(currentStep, prevStep) {
      document.getElementById(`step${currentStep}Form`).style.display = 'none';
      document.getElementById(`step${prevStep}Form`).style.display = 'block';
      updateProgress(prevStep);
      profilePanel.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    // 21.31 Генерация прогноза на основе данных
    async function generateForecast(data, period = 'день') {
      const zodiac = getZodiacSign(data.birth_date, data.zodiac_system || 'tropical');
      
      if (!zodiac) {
        return '<p>Не удалось определить знак зодиака. Пожалуйста, проверьте дату рождения.</p>';
      }
      
      // Определяем период для API
      let apiPeriod = 'today';
      if (period === 'неделю') apiPeriod = 'week';
      if (period === 'месяц') apiPeriod = 'month';
      if (period === 'год') apiPeriod = 'year';
      
      // Получаем гороскоп из API
      const horoscope = await getHoroscope(zodiac, apiPeriod);
      
      if (!horoscope) {
        return '<p>Не удалось получить прогноз. Пожалуйста, попробуйте позже.</p>';
      }
      
      // Сохраняем текущий прогноз
      currentForecast = {
        ...horoscope,
        name: data.name,
        interest: data.interest,
        relationship: data.relationship,
        periodName: period
      };
      
      // Формируем HTML прогноза
      let forecastHTML = `
        <div class="forecast-section">
          <h3><i class="fas fa-user-astronaut"></i> Персональные данные</h3>
          <p>Имя: ${data.name}</p>
          <p>Знак зодиака: ${zodiac}</p>
          <p>Интерес: ${data.interest}</p>
        </div>
        
        <div class="forecast-section">
          <h3><i class="fas fa-star"></i> Основной прогноз</h3>
          <p>${horoscope.description}</p>
      `;
      
      if (period === 'день') {
        forecastHTML += `
          <p><strong>Дата прогноза:</strong> ${horoscope.date}</p>
        `;
      }
      
      forecastHTML += `</div>`;
      
      // Добавляем персонализированные рекомендации
      forecastHTML += `
        <div class="forecast-section">
          <h3><i class="fas fa-lightbulb"></i> Персональные рекомендации</h3>
          <p>${getPersonalAdvice(data, horoscope, period)}</p>
        </div>
      `;
      
      // Устанавливаем заголовок прогноза
      forecastTitle.innerHTML = `<i class="fas fa-crystal-ball"></i> Ваш персональный астропрогноз на ${period}`;
      
      return forecastHTML;
    }
    
    // 21.32 Генерация персонализированных рекомендаций
    function getPersonalAdvice(data, horoscope, period) {
      let advice = '';
      
      if (data.interest === 'Любовь и отношения') {
        if (data.relationship === 'В паре') {
          advice = `💑 В этот ${period} звезды рекомендуют уделить больше внимания партнеру. Хорошее время для ваших отношений.`;
        } else {
          advice = `💕 Этот ${period} благоприятен для новых знакомств. Будьте открыты для новых встреч.`;
        }
      } 
      else if (data.interest === 'Карьера и бизнес') {
        advice = `💼 Профессиональная сфера: ${horoscope.description.split('.')[0]}. Используйте этот ${period} для важных переговоров.`;
      }
      else if (data.interest === 'Финансы и инвестиции') {
        advice = `💰 Финансовая удача сегодня зависит от ваших решений. ${horoscope.description.split('.')[0] || 'Звезды советуют быть внимательнее.'}`;
      }
      else if (data.interest === 'Здоровье и благополучие') {
        advice = `🌿 Этот ${period} - хорошее время для заботы о здоровье. ${horoscope.description.split('.')[0] || 'Прислушайтесь к своему телу.'}`;
      }
      else {
        advice = `✨ Для вас в этот ${period}: ${horoscope.description.split('.')[0]}. Следуйте своей интуиции.`;
      }
      
      return advice;
    }
    
    // 21.33 Показать уведомление
    function showNotification(message, type = 'success') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.classList.add('fade-out');
        setTimeout(() => {
          notification.remove();
        }, 300);
      }, 3000);
    }
    
    // 21.34 Отображение данных профиля
    function displayProfileData(data) {
      if (!data || !data.name) {
        profileData.innerHTML = '<p>Анкета еще не заполнена.</p>';
        refLinkContainer.style.display = 'none';
        return;
      }
      
      const zodiac = getZodiacSign(data.birth_date, data.zodiac_system || 'tropical');
      
      profileData.innerHTML = `
        <p><strong>Имя:</strong> ${data.name}</p>
        <p><strong>Пол:</strong> ${data.gender === 'м' ? 'Мужской' : 'Женский'}</p>
        <p><strong>Дата рождения:</strong> ${new Date(data.birth_date).toLocaleDateString('ru-RU')}</p>
        ${data.birth_time ? `<p><strong>Время рождения:</strong> ${data.birth_time}</p>` : ''}
        <p><strong>Город рождения:</strong> ${data.birth_city}</p>
        <p><strong>Знак зодиака:</strong> ${zodiac || 'Не определен'}</p>
        <p><strong>Система зодиака:</strong> ${data.zodiac_system === 'sidereal' ? 'Сидерический (ведический)' : 'Тропический (западный)'}</p>
        <p><strong>Основной интерес:</strong> ${data.interest}</p>
        <p><strong>Семейное положение:</strong> ${data.relationship}</p>
      `;
      
      // Показываем реферальную ссылку
      refLinkContainer.style.display = 'block';
      generateRefLink(data.name);
    }
    
    // 21.35 Генерация реферальной ссылки
    function generateRefLink(name) {
      const refCode = `ref_${name.toLowerCase().replace(/\s+/g, '')}_${Math.floor(1000 + Math.random() * 9000)}`;
      localStorage.setItem('refCode', refCode);
      
      const refUrl = `https://t.me/astropred_bot?start=${refCode}`;
      refLink.innerHTML = `<i class="fas fa-link"></i> ${refUrl}`;
      
      // Добавляем обработчик копирования ссылки
      refLink.onclick = () => {
        navigator.clipboard.writeText(refUrl)
          .then(() => showNotification('Ссылка скопирована!', 'success'))
          .catch(() => showNotification('Не удалось скопировать ссылку', 'error'));
      };
    }
    
    // 21.36 Переключение между режимами просмотра и редактирования анкеты
    function toggleProfileViewMode(editMode = false) {
      if (editMode) {
        // Режим редактирования
        profileView.style.display = 'none';
        profileForm.style.display = 'block';
        formProgressContainer.style.display = 'block';
        editProfileBtn.style.display = 'none';
        
        // Показываем первый шаг формы
        step1Form.style.display = 'block';
        step2Form.style.display = 'none';
        step3Form.style.display = 'none';
        updateProgress(1);
      } else {
        // Режим просмотра
        profileView.style.display = 'block';
        profileForm.style.display = 'none';
        formProgressContainer.style.display = 'none';
        
        // Показываем кнопку редактирования, если есть данные
        const savedData = localStorage.getItem('astroProfileData');
        editProfileBtn.style.display = savedData ? 'block' : 'none';
      }
    }
    
    // 21.37 Добавление звезд на счет
    function addStars(count, reason = '') {
      let currentStars = parseInt(localStorage.getItem('starsCount')) || 0;
      currentStars += count;
      localStorage.setItem('starsCount', currentStars);
      starsCount.textContent = currentStars;
      
      // Анимация добавления звезд
      starsCounter.classList.add('star-added');
      setTimeout(() => {
        starsCounter.classList.remove('star-added');
      }, 500);
      
      // Показываем уведомление о начислении
      if (reason) {
        showNotification(`+${count} звезд за ${reason}`, 'success');
      }
      
      // Проверяем достижения
      checkAchievements(currentStars);
      
      return currentStars;
    }
    
    // 21.38 Проверка достижений
    function checkAchievements(currentStars) {
      const achievements = [
        { id: 'first_steps', title: 'Первые шаги', description: 'Получите 10 звезд', threshold: 10, icon: 'fa-shoe-prints' },
        { id: 'astrology_learner', title: 'Ученик астрологии', description: 'Получите 25 звезд', threshold: 25, icon: 'fa-book' },
        { id: 'astrology_expert', title: 'Эксперт астрологии', description: 'Получите 50 звезд', threshold: 50, icon: 'fa-graduation-cap' },
        { id: 'astrology_master', title: 'Мастер астрологии', description: 'Получите 100 звезд', threshold: 100, icon: 'fa-crown' }
      ];
      
      const unlockedAchievements = JSON.parse(localStorage.getItem('achievements')) || [];
      
      achievements.forEach(achievement => {
        if (currentStars >= achievement.threshold && !unlockedAchievements.includes(achievement.id)) {
          unlockedAchievements.push(achievement.id);
          showNotification(`Достижение разблокировано: ${achievement.title}`, 'info');
          
          // Показываем красивый алерт для достижения
          Swal.fire({
            title: 'Новое достижение!',
            text: achievement.title,
            icon: 'success',
            confirmButtonText: 'Отлично!'
          });
        }
      });
      
      localStorage.setItem('achievements', JSON.stringify(unlockedAchievements));
    }
    
    // 21.39 Показать случайный бонус
    function showRandomBonus() {
      const now = Date.now();
      const timeLeft = lastBonusTime + BONUS_COOLDOWN - now;
      
      if (timeLeft > 0) {
        const hoursLeft = Math.ceil(timeLeft / (60 * 60 * 1000));
        showNotification(`Вы сможете получить новый бонус через ${hoursLeft} часа(ов)`, 'error');
        return;
      }
      
      const randomIndex = Math.floor(Math.random() * bonusPhrases.length);
      bonusText.textContent = bonusPhrases[randomIndex];
      
      // Начисляем звезды за бонус
      const starsToAdd = 1 + Math.floor(Math.random() * 3); // 1-3 звезды
      starsAddedCount.textContent = starsToAdd;
      starsAdded.style.display = 'block';
      addStars(starsToAdd, 'получение бонуса');
      
      // Показываем кнопку "Поделиться бонусом"
      shareBonusBtn.style.display = 'block';
      
      // Показываем оверлей и сообщение
      overlay.style.display = 'block';
      bonusMessage.style.display = 'block';
      
      // Сохраняем время получения бонуса
      lastBonusTime = now;
      localStorage.setItem('lastBonusTime', lastBonusTime);
      
      // Обновляем состояние кнопки
      updateBonusButton();
    }
    
    // 21.40 Обновить состояние кнопки бонуса
    function updateBonusButton() {
      const now = Date.now();
      const timeLeft = lastBonusTime + BONUS_COOLDOWN - now;
      
      if (timeLeft > 0) {
        const hoursLeft = Math.ceil(timeLeft / (60 * 60 * 1000));
        bonusBtn.innerHTML = `<i class="fas fa-clock"></i> До бонуса: ${hoursLeft}ч`;
        bonusBtn.disabled = true;
        bonusBtn.classList.remove('btn-pulse');
      } else {
        bonusBtn.innerHTML = '<i class="fas fa-gift"></i> Получить бонус';
        bonusBtn.disabled = false;
        bonusBtn.classList.add('btn-pulse');
      }
    }
    
    // 21.41 Переключение темы (светлая/тёмная) с иконкой
    function toggleTheme() {
      const root = document.documentElement;
      const isLight = root.classList.toggle('light-theme');
      localStorage.setItem('theme', isLight ? 'light' : 'dark');

      // Обновляем иконку
      const themeIcon = document.getElementById('themeIcon');
      if (themeIcon) {
        themeIcon.innerHTML = isLight
          ? '<i class="fas fa-sun"></i>'
          : '<i class="fas fa-moon"></i>';
      }
      
      // Пересоздаем звезды для соответствия теме
      document.getElementById('stars-container').innerHTML = '';
      createStars();
    }
    
    // 21.42 Проверка реферального кода
    function checkReferral() {
      if (tg && tg.initDataUnsafe && tg.initDataUnsafe.start_param) {
        const refCode = tg.initDataUnsafe.start_param;
        if (refCode && refCode.startsWith('ref')) {
          // Начисляем звезды за приглашенного друга
          addStars(5, 'приглашение друга');
          showNotification('Вы получили 5 звезд за приглашенного друга!', 'success');
        }
      }
    }
    
    // 21.43 Сохранение прогноза в localStorage
    function saveForecast() {
      if (!currentForecast) return;
      
      const savedForecasts = JSON.parse(localStorage.getItem('savedForecasts')) || [];
      
      // Проверяем, не сохранен ли уже этот прогноз
      const exists = savedForecasts.some(f => 
        f.date === currentForecast.date && 
        f.period === currentForecast.period && 
        f.zodiacSign === currentForecast.zodiacSign
      );
      
      if (exists) {
        showNotification('Этот прогноз уже сохранен', 'info');
        return;
      }
      
      savedForecasts.push(currentForecast);
      localStorage.setItem('savedForecasts', JSON.stringify(savedForecasts));
      
      // Начисляем звезды за сохранение
      addStars(1, 'сохранение прогноза');
      showNotification('Прогноз сохранен! (+1 звезда)', 'success');
    }
    
    // 21.44 Добавление данных партнера для сравнения
    function addPartnerData() {
      Swal.fire({
        title: 'Добавить данные партнера',
        html: `
          <input type="text" id="partnerName" class="swal2-input" placeholder="Имя">
          <input type="date" id="partnerBirthDate" class="swal2-input" placeholder="Дата рождения">
          <select id="partnerZodiacSystem" class="swal2-input">
            <option value="tropical">Тропический зодиак</option>
            <option value="sidereal">Сидерический зодиак</option>
          </select>
        `,
        focusConfirm: false,
        preConfirm: () => {
          return {
            name: document.getElementById('partnerName').value,
            birth_date: document.getElementById('partnerBirthDate').value,
            zodiac_system: document.getElementById('partnerZodiacSystem').value
          };
        }
      }).then((result) => {
        if (result.isConfirmed) {
          const partnerData = result.value;
          if (!partnerData.birth_date) {
            showNotification('Пожалуйста, укажите дату рождения', 'error');
            return;
          }
          
          localStorage.setItem('partnerData', JSON.stringify(partnerData));
          
          // Обновляем отчет о совместимости
          const userData = JSON.parse(localStorage.getItem('astroProfileData'));
          generateCompatibilityReport(userData, partnerData);
          
          showNotification('Данные партнера сохранены', 'success');
          addStars(2, 'анализ совместимости');
        }
      });
    }
    
    // 21.45 Инициализация приложения
    function initApp() {
      // Сначала применяем сохранённую тему
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme === 'light') {
        document.documentElement.classList.add('light-theme');
      }

      // Затем создаём звёзды (с учётом темы)
      createStars();

      // Проверяем, есть ли сохранённые данные анкеты
      const savedData = localStorage.getItem('astroProfileData');
      if (savedData) {
        const data = JSON.parse(savedData);

        // Заполняем форму сохранёнными данными
        for (const key in data) {
          if (profileForm.elements[key]) {
           profileForm.elements[key].value = data[key];
          }
        }

        // Показываем данные в режиме просмотра
        displayProfileData(data);
        toggleProfileViewMode(false);
      } else {
        // Если данных нет — открываем форму
        toggleProfileViewMode(true);
      }

      // Инициализация автодополнения для города
      new Awesomplete(document.getElementById('birth_city'), {
        list: ['Москва', 'Санкт-Петербург', 'Новосибирск', 'Екатеринбург', 'Казань', 'Нижний Новгород', 
               'Челябинск', 'Самара', 'Омск', 'Ростов-на-Дону', 'Уфа', 'Красноярск', 'Пермь', 'Воронеж', 
               'Волгоград', 'Краснодар', 'Саратов', 'Тюмень', 'Тольятти', 'Ижевск', 'Барнаул', 'Ульяновск'],
        minChars: 1,
        maxItems: 10
      });

      // Инициализация счетчика звезд
      const savedStars = parseInt(localStorage.getItem('starsCount')) || 0;
      starsCount.textContent = savedStars;
      
      // Обновляем состояние кнопки бонуса
      updateBonusButton();
      
      // Проверяем реферальный код
      checkReferral();
      
      // Начисляем звезды за первый запуск
      if (!localStorage.getItem('firstLaunch')) {
        addStars(3, 'первый запуск');
        localStorage.setItem('firstLaunch', 'true');
      }
    }

    // 21.46 Обработчики событий
    profileBtn.addEventListener('click', () => {
      showPanel(profilePanel);
      
      // Проверяем, есть ли сохраненные данные
      const savedData = localStorage.getItem('astroProfileData');
      if (savedData) {
        // Если есть - показываем режим просмотра
        toggleProfileViewMode(false);
      } else {
        // Если нет - показываем форму для заполнения
        toggleProfileViewMode(true);
      }
    });
    
    // Обработчик кнопки редактирования профиля
    editProfileBtn.addEventListener('click', () => {
      toggleProfileViewMode(true);
    });
    
    // Обработчик кнопки натальной карты
    natalChartBtn.addEventListener('click', () => {
      const savedData = localStorage.getItem('astroProfileData');
      if (!savedData) {
        showNotification('Пожалуйста, сначала заполните анкету', 'error');
        showPanel(profilePanel);
        return;
      }
      
      showPanel(natalChartPanel);
    });
    
    dailyForecastBtn.addEventListener('click', async () => {
      const savedData = localStorage.getItem('astroProfileData');
      if (!savedData) {
        showNotification('Пожалуйста, сначала заполните анкету', 'error');
        showPanel(profilePanel);
        return;
      }
      
      const data = JSON.parse(savedData);
      
      // Показываем индикатор загрузки
      dailyForecastBtn.disabled = true;
      dailyForecastBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Загрузка...';
      
      forecastContent.innerHTML = await generateForecast(data, 'день');
      forecastDate.textContent = `Прогноз на ${new Date().toLocaleDateString('ru-RU')}`;
      showPanel(forecastPanel);
      
      // Возвращаем кнопку в исходное состояние
      dailyForecastBtn.disabled = false;
      dailyForecastBtn.innerHTML = '<i class="fas fa-sun"></i> Прогноз на день';
    });
    
    weeklyForecastBtn.addEventListener('click', async () => {
      const savedData = localStorage.getItem('astroProfileData');
      if (!savedData) {
        showNotification('Пожалуйста, сначала заполните анкету', 'error');
        showPanel(profilePanel);
        return;
      }
      
      const data = JSON.parse(savedData);
      
      // Показываем индикатор загрузки
      weeklyForecastBtn.disabled = true;
      weeklyForecastBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Загрузка...';
      
      forecastContent.innerHTML = await generateForecast(data, 'неделю');
      forecastDate.textContent = `Прогноз на неделю ${new Date().toLocaleDateString('ru-RU', { month: 'long', year: 'numeric' })}`;
      showPanel(forecastPanel);
      
      // Возвращаем кнопку в исходное состояние
      weeklyForecastBtn.disabled = false;
      weeklyForecastBtn.innerHTML = '<i class="fas fa-calendar-week"></i> Прогноз на неделю';
    });
    
    monthlyForecastBtn.addEventListener('click', async () => {
      const savedData = localStorage.getItem('astroProfileData');
      if (!savedData) {
        showNotification('Пожалуйста, сначала заполните анкету', 'error');
        showPanel(profilePanel);
        return;
      }
      
      const data = JSON.parse(savedData);
      
      // Показываем индикатор загрузки
      monthlyForecastBtn.disabled = true;
      monthlyForecastBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Загрузка...';
      
      forecastContent.innerHTML = await generateForecast(data, 'месяц');
      forecastDate.textContent = `Прогноз на месяц ${new Date().toLocaleDateString('ru-RU', { month: 'long', year: 'numeric' })}`;
      showPanel(forecastPanel);
      
      // Возвращаем кнопку в исходное состояние
      monthlyForecastBtn.disabled = false;
      monthlyForecastBtn.innerHTML = '<i class="fas fa-calendar-alt"></i> Прогноз на месяц';
    });
    
    // Обработчик кнопки транзитов
    transitsBtn.addEventListener('click', () => {
      const savedData = localStorage.getItem('astroProfileData');
      if (!savedData) {
        showNotification('Пожалуйста, сначала заполните анкету', 'error');
        showPanel(profilePanel);
        return;
      }
      
      showPanel(transitsPanel);
    });
    
    // Обработчик кнопки лунного календаря
    moonBtn.addEventListener('click', () => {
      showPanel(moonPanel);
    });
    
    // Обработчик кнопки обучения
    learningBtn.addEventListener('click', () => {
      showPanel(learningPanel);
    });
    
    // Обработчики закрытия панелей
    closeProfilePanel.addEventListener('click', hideAllPanels);
    closeForecastPanel.addEventListener('click', hideAllPanels);
    closeNatalChartPanel.addEventListener('click', hideAllPanels);
    closeTransitsPanel.addEventListener('click', hideAllPanels);
    closeMoonPanel.addEventListener('click', hideAllPanels);
    closeLearningPanel.addEventListener('click', hideAllPanels);
    
    // Обработчики шагов анкеты
    nextStep1.addEventListener('click', () => goToNextStep(1, 2));
    nextStep2.addEventListener('click', () => goToNextStep(2, 3));
    prevStep2.addEventListener('click', () => goToPrevStep(2, 1));
    prevStep3.addEventListener('click', () => goToPrevStep(3, 2));
    
    // Обработка сохранения анкеты
    profileForm.addEventListener('submit', (e) => {
      e.preventDefault();
      
      if (!profileForm.checkValidity()) {
        showNotification('Пожалуйста, заполните все обязательные поля', 'error');
        return;
      }
      
      const formData = new FormData(profileForm);
      const data = Object.fromEntries(formData.entries());
      
      // Сохраняем данные в localStorage
      localStorage.setItem('astroProfileData', JSON.stringify(data));
      
      // Показываем данные профиля
      displayProfileData(data);
      
      // Переключаемся в режим просмотра
      toggleProfileViewMode(false);
      
      // Начисляем звезды за заполнение анкеты
      addStars(5, 'заполнение анкеты');
      
      // Показываем уведомление об успешном сохранении
      showNotification('Анкета успешно сохранена (+5 звезд)', 'success');
    });
    
    // Поделиться через Telegram
    document.getElementById('shareTelegram').addEventListener('click', () => {
      const text = `Мой астропрогноз на сегодня:\n${forecastContent.textContent.substring(0, 200)}...\n\nПолный прогноз в приложении AstroPred!`;
      if (tg && tg.isTelegram) {
        tg.sendData(text);
      } else {
        const url = `https://t.me/share/url?url=${encodeURIComponent(window.location.href)}&text=${encodeURIComponent(text)}`;
        window.open(url, '_blank');
      }
      
      // Начисляем звезды за шаринг
      addStars(2, 'поделиться прогнозом');
    });
    
    // Поделиться через WhatsApp
    document.getElementById('shareWhatsApp').addEventListener('click', () => {
      const text = `Мой астропрогноз на сегодня:\n${forecastContent.textContent.substring(0, 200)}...\n\nПолный прогноз в приложении AstroPred!`;
      const url = `https://wa.me/?text=${encodeURIComponent(text + '\n\n' + window.location.href)}`;
      window.open(url, '_blank');
      
      // Начисляем звезды за шаринг
      addStars(2, 'поделиться прогнозом');
    });
    
    // Сохранить прогноз
    saveForecastBtn.addEventListener('click', saveForecast);
    
    // Поделиться бонусом
    shareBonusBtn.addEventListener('click', () => {
      const text = `Мой астрологический бонус на сегодня: ${bonusText.textContent}\n\nПолучи свой бонус в приложении AstroPred!`;
      
      if (navigator.share) {
        navigator.share({
          title: 'Мой астрологический бонус',
          text: text,
          url: window.location.href
        }).then(() => {
          addStars(1, 'поделиться бонусом');
        }).catch(console.error);
      } else if (tg && tg.isTelegram) {
        tg.sendData(text);
        addStars(1, 'поделиться бонусом');
      } else {
        navigator.clipboard.writeText(text)
          .then(() => {
            showNotification('Бонус скопирован в буфер обмена!', 'success');
            addStars(1, 'поделиться бонусом');
          })
          .catch(() => showNotification(text, 'info'));
      }
    });
    
    // Поделиться приложением
    shareAppBtn.addEventListener('click', () => {
      // Используем сохраненный реферальный код или генерируем новый
      let refCode = localStorage.getItem('refCode');
      if (!refCode) {
        const savedData = localStorage.getItem('astroProfileData');
        const name = savedData ? JSON.parse(savedData).name : 'friend';
        refCode = `ref_${name.toLowerCase().replace(/\s+/g, '')}_${Math.floor(1000 + Math.random() * 9000)}`;
        localStorage.setItem('refCode', refCode);
      }
      
      const shareUrl = `https://t.me/astropred_bot?start=${refCode}`;

      if (navigator.share) {
        navigator.share({
          title: 'AstroPred — Астрологический помощник',
          text: 'Попробуй AstroPred — это работает магически ✨',
          url: shareUrl
        }).then(() => {
          // Начисляем звезды за шаринг
          addStars(3, 'поделиться приложением');
        }).catch(console.error);
      } else if (tg && tg.isTelegram) {
        tg.sendData(shareUrl);
        addStars(3, 'поделиться приложением');
      } else {
        navigator.clipboard.writeText(shareUrl)
          .then(() => {
            showNotification('Ссылка скопирована в буфер обмена!', 'success');
            addStars(3, 'поделиться приложением');
          })
          .catch(() => showNotification(`Ссылка для приглашения: ${shareUrl}`, 'info'));
      }
    });
    
    // Показать бонусное сообщение
    bonusBtn.addEventListener('click', showRandomBonus);
    
    // Закрыть бонусное сообщение
    closeBonusMessage.addEventListener('click', () => {
      overlay.style.display = 'none';
      bonusMessage.style.display = 'none';
    });
    
    // Закрыть бонусное сообщение при клике на оверлей
    overlay.addEventListener('click', () => {
      overlay.style.display = 'none';
      bonusMessage.style.display = 'none';
    });
    
    // Переключение темы по клику на логотип
    themeToggle.addEventListener('click', toggleTheme);
    
    // Клик по счетчику звезд
    starsCounter.addEventListener('click', () => {
      const count = parseInt(localStorage.getItem('starsCount')) || 0;
      showNotification(`У вас ${count} звезд!`, 'info');
    });
    
    // Добавление партнера для сравнения
    addPartnerBtn.addEventListener('click', addPartnerData);
    
    // Запуск приложения
    window.addEventListener('load', initApp);
  </script>
</body>
</html>
