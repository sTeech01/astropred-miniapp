<!DOCTYPE html>
<html lang="ru">
<head>
  <!-- Блок 1: Голова документа с мета-тегами и стилями -->
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AstroPred</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
      .hidden { display: none; }
      .form-section { display: none; }
      .form-section.active { display: block; }
      .bonus-content, .share-message { color: #16a34a; font-style: italic; }
      .bonus-container, .share-container { position: relative; min-height: 60px; }
      .bonus-feedback, .share-feedback { position: absolute; top: 100%; left: 50%; transform: translateX(-50%); width: 100%; text-align: center; }
    </style>
  </head>
  
  <!-- 2. Подключение библиотек -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.css">
  
  <!-- 3. Стили приложения -->
  <style>
    /* 3.1 CSS переменные для темной темы (по умолчанию) */
    :root {
      --primary-color: #9370db;
      --secondary-color: #6a5acd;
      --text-color: #f0f0f0;
      --bg-color: #0a0a1a;
      --card-color: rgba(22, 33, 62, 0.8);
      --error-color: #ff6b6b;
      --success-color: #4caf50;
      --info-color: #4285f4;
      --warning-color: #ff9800;
      --panel-width: 75%;
      --transition-speed: 0.3s;
    }
    
    /* 3.2 CSS переменные для светлой темы */
    :root.light-theme {
      --primary-color: #6a5acd;
      --secondary-color: #483d8b;
      --text-color: #333333;
      --bg-color: #f5f5f5;
      --card-color: rgba(255, 255, 255, 0.9);
      --error-color: #e74c3c;
      --success-color: #27ae60;
      --info-color: #3498db;
      --warning-color: #f39c12;
    }
    
    /* 3.3 Основные стили тела документа */
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      color: var(--text-color);
      background: var(--bg-color);
      transition: all var(--transition-speed) ease;
      position: relative;
      overflow-x: hidden;
      min-height: 100vh;
    }
    
    /* 3.4 Контейнер для звездного фона */
    #stars-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      overflow: hidden;
    }
    
    /* 3.5 Стили для звезд */
    .star {
      position: absolute;
      background-color: var(--text-color);
      border-radius: 50%;
      animation: twinkle var(--duration) infinite ease-in-out;
    }
    
    /* 3.6 Анимация мерцания звезд */
    @keyframes twinkle {
      0%, 100% { opacity: 0.2; }
      50% { opacity: 1; }
    }
    
    /* 3.7 Стили главного меню */
    #mainMenu {
      padding: 20px;
      transition: all var(--transition-speed) ease;
      position: relative;
      z-index: 1;
      padding-bottom: 120px;
    }
    
    /* 3.8 Стиль для заголовка анкеты */
    .side-panel > h2 {
      margin-top: 0;
      padding-top: 10px;
    }
    
    /* 3.9 Контейнер логотипа */
    .logo-container {
      text-align: center;
      margin-bottom: 30px;
      cursor: pointer;
    }
    
    /* 3.10 Стили SVG логотипа */
    .logo-svg {
      width: 120px;
      height: 120px;
      margin-bottom: 15px;
    }
    
    /* 3.11 Текст логотипа */
    .logo-text {
      font-size: 28px;
      font-weight: bold;
      color: var(--primary-color);
      margin-top: 10px;
    }
    
    /* 3.12 Стили главного меню */
    .main-menu {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-top: 20px;
    }
    
    /* 3.13 Боковая панель */
    .side-panel {
      position: fixed;
      top: 0;
      right: -100%;
      width: var(--panel-width);
      height: 100vh;
      background: var(--bg-color);
      box-shadow: -5px 0 15px rgba(0,0,0,0.3);
      z-index: 100;
      overflow-y: auto;
      transition: right var(--transition-speed) ease;
      padding: 50px 20px 20px;
      border-left: 1px solid rgba(255,255,255,0.1);
    }
    
    /* 3.14 Активное состояние боковой панели */
    .side-panel.active {
      right: 0;
    }
    
    /* 3.15 Кнопка закрытия панели */
    .close-panel {
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      color: var(--text-color);
      font-size: 24px;
      cursor: pointer;
    }
    
    /* 3.16 Основные стили кнопок */
    .btn {
      position: relative;
      overflow: hidden;
      padding: 14px 20px;
      border-radius: 12px;
      border: none;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      background-color: var(--primary-color);
      color: white;
    }
    
    /* 3.17 Состояния кнопок */
    .btn:hover {
      background-color: var(--secondary-color);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .btn:disabled {
      background-color: #555;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    /* 3.18 Стили для разных типов кнопок */
    .btn-success {
      background-color: var(--success-color);
    }
    
    .btn-error {
      background-color: var(--error-color);
    }
    
    .btn-info {
      background-color: var(--info-color);
    }
    
    .btn-warning {
      background-color: var(--warning-color);
    }
    
    /* 3.19 Эффект ripple для кнопок */
    .btn::after {
      content: "";
      position: absolute;
      top: 50%;
      left: 50%;
      width: 5px;
      height: 5px;
      background: rgba(255, 255, 255, 0.5);
      opacity: 0;
      border-radius: 100%;
      transform: scale(1, 1) translate(-50%, -50%);
      transform-origin: 50% 50%;
    }
    
    .btn:focus:not(:active)::after {
      animation: ripple 0.6s ease-out;
    }
    
    /* 3.20 Анимация ripple эффекта */
    @keyframes ripple {
      0% {
        transform: scale(0, 0);
        opacity: 0.5;
      }
      100% {
        transform: scale(20, 20);
        opacity: 0;
      }
    }
    
    /* 3.21 Стили форм */
    form {
      display: flex;
      flex-direction: column;
      gap: 20px;
      background: var(--card-color);
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
      transition: all var(--transition-speed) ease;
      backdrop-filter: blur(5px);
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    /* 3.22 Группы полей формы */
    .form-group {
      position: relative;
      animation: fadeIn 0.5s ease forwards;
      opacity: 0;
    }
    
    /* 3.23 Стили меток */
    label {
      font-weight: 600;
      display: block;
      margin-bottom: 8px;
      color: var(--text-color);
    }
    
    label i {
      margin-right: 8px;
      color: var(--primary-color);
      width: 20px;
      text-align: center;
    }
    
    /* 3.24 Стили полей ввода */
    input, select, textarea {
      padding: 12px 15px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.2);
      font-size: 16px;
      width: 100%;
      box-sizing: border-box;
      background: rgba(0,0,0,0.3);
      color: var(--text-color);
      transition: all var(--transition-speed) ease;
      font-family: 'Inter', sans-serif;
    }

    input::placeholder,
    textarea::placeholder {
      color: rgba(255,255,255,0.5);
      transition: opacity var(--transition-speed) ease;
    }

    input:focus::placeholder,
    textarea:focus::placeholder {
      opacity: 0.5;
    }

    /* Специфика для select: добавим стрелочку */
    select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg fill='%23cccccc' height='24' viewBox='0 0 24 24' width='24' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 18px 18px;
      padding-right: 40px;
      cursor: pointer;
    }

    textarea {
      min-height: 100px;
      resize: vertical;
    }
  
    /* 3.25 Состояния полей ввода */
    input:focus, select:focus, textarea:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(106, 90, 205, 0.3);
      outline: none;
    }
    
    input:invalid, select:invalid {
      border-color: var(--error-color);
    }
    
    /* 3.26 Контейнер прогресс-бара */
    .progress-container {
      width: 100%;
      background: rgba(0,0,0,0.2);
      border-radius: 10px;
      margin-bottom: 20px;
      overflow: hidden;
    }
    
    /* 3.27 Прогресс-бар */
    .progress-bar {
      height: 8px;
      background: var(--primary-color);
      border-radius: 10px;
      transition: width 0.4s ease;
    }
    
    /* 3.28 Шаги прогресса */
    .progress-steps {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
      font-size: 14px;
      color: var(--text-color);
    }
    
    /* 3.29 Стили шагов */
    .step {
      text-align: center;
      flex: 1;
      position: relative;
    }
    
    .step.active {
      color: var(--primary-color);
      font-weight: bold;
    }
    
    .step.completed::before {
      content: "✓";
      color: var(--success-color);
      margin-right: 5px;
    }
    
    /* 3.30 Контейнер прогноза */
    .forecast-container {
      background: var(--card-color);
      padding: 25px;
      border-radius: 15px;
      margin-top: 20px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
      backdrop-filter: blur(5px);
      border: 1px solid rgba(255,255,255,0.1);
      animation: slideUp 0.5s ease forwards;
    }
    
    /* 3.31 Заголовок прогноза */
    .forecast-header {
      text-align: center;
      margin-bottom: 20px;
      color: var(--primary-color);
    }
    
    /* 3.32 Контент прогноза */
    .forecast-content {
      line-height: 1.6;
    }
    
    /* 3.33 Секции прогноза */
    .forecast-section {
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px dashed rgba(255,255,255,0.1);
    }
    
    /* 3.34 Заголовки секций */
    .forecast-section h3 {
      color: var(--primary-color);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    /* 3.35 Просмотр профиля */
    .profile-view {
      background: var(--card-color);
      padding: 25px;
      border-radius: 15px;
      margin-top: 20px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
      backdrop-filter: blur(5px);
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    /* 3.36 Заголовки профиля */
    .profile-view h3 {
      color: var(--primary-color);
      margin-bottom: 20px 0 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    /* 3.37 Параграфы профиля */
    .profile-view p {
      margin-bottom: 10px;
      padding-left: 10px;
    }
    
    /* 3.38 Кнопки "Поделиться" */
    .share-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      justify-content: space-between;
    }

    .share-buttons .btn {
      flex: 1;
      min-width: 0;
    }
    
    /* 3.39 Кнопки внизу экрана */
    .bottom-buttons {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: calc(100% - 40px);
      max-width: 400px;
      z-index: 10;
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding-bottom: env(safe-area-inset-bottom);
    }
    
    /* 3.40 Навигация по форме */
    .form-navigation {
      display: flex;
      justify-content: space-between;
      gap: 20px;
      margin-top: 20px;
    }
    
    .form-navigation .btn {
      flex: 1;
    }
    
    /* 3.41 Бонусное сообщение */
    .bonus-message {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) !important;
      width: calc(100% - 40px);
      max-width: 400px;
      box-sizing: border-box;
      padding: 20px;
      background: var(--card-color);
      border-radius: 15px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
      z-index: 1000;
      text-align: center;
      display: none;
      overflow: visible;
      white-space: normal;
    }
    
    .bonus-message h3 {
      color: var(--primary-color);
      margin-bottom: 10px;
    }
    
    .bonus-message p {
      line-height: 1.6;
    }
    
    .bonus-message .close-bonus {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      color: var(--text-color);
      font-size: 18px;
      cursor: pointer;
    }
    
    /* 3.42 Оверлей */
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 999;
      display: none;
    }
    
    /* 3.43 Анимации */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translate(-50%, 20px); }
      to { opacity: 1; transform: translate(-50%, 0); }
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes themeChange {
      from { opacity: 0.8; }
      to { opacity: 1; }
    }

    .theme-changing {
      animation: themeChange 0.3s ease;
    }
    
    /* 3.44 Адаптивные стили */
    @media (max-width: 400px) {
      :root {
        --panel-width: 95%;
      }
      .forecast-container {
        padding: 10px;
      }
    }
      
    @media (max-width: 480px) {
      :root {
        --panel-width: 90%;
      }
      
      .share-buttons {
        flex-direction: row;
        gap: 8px;
      }
    }
    
    /* 3.45 Лоадер */
    .loader {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
      margin-left: 10px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* 3.46 Уведомления */
    .notification {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 20px;
      border-radius: 8px;
      color: white;
      z-index: 1000;
      animation: slideIn 0.3s ease forwards;
    }
    
    .notification.success {
      background-color: var(--success-color);
    }
    
    .notification.error {
      background-color: var(--error-color);
    }
    
    .notification.fade-out {
      animation: fadeOut 0.3s ease forwards;
    }
  </style>
</head>
<body>
  <!-- 4. Контейнер для звездного фона -->
  <div id="stars-container"></div>
  
  <!-- 5. Главное меню -->
  <div id="mainMenu">
    <div class="logo-container" id="themeToggle">
      <svg class="logo-svg" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <path id="star-path" d="M100,20 L123.5,70 L177.6,76.8 L137.8,113.9 L149.1,167.6 L100,142 L50.9,167.6 L62.2,113.9 L22.4,76.8 L76.5,70 Z" />
          <circle id="circle-path" cx="100" cy="100" r="80" />
        </defs>
        
        <text x="100" y="110" text-anchor="middle" font-size="24" fill="#9370db" font-weight="bold">AstroPred</text>
        
        <use href="#star-path" x="0" y="0" fill="none" stroke="#9370db" stroke-width="2">
          <animateTransform attributeName="transform" type="rotate" from="0 100 100" to="360 100 100" dur="20s" repeatCount="indefinite" />
        </use>
        
        <use href="#circle-path" fill="none" stroke="#6a5acd" stroke-width="2" stroke-dasharray="10,5">
          <animate attributeName="stroke-dashoffset" values="0;500;0" dur="15s" repeatCount="indefinite" />
        </use>
      </svg>
      <div class="logo-text">AstroPred</div>
      <span id="themeIcon" style="margin-top: 10px; font-size: 20px; display: block;">
        <i class="fas fa-moon"></i>
      </span>
    </div>
    
    <!-- Блок 6: Секция кнопок бонуса и шаринга -->
    <div class="mt-6 flex justify-center space-x-6">
      <div class="bonus-container">
        <button onclick="getBonus()" class="bg-purple-500 text-white p-3 rounded-lg hover:bg-purple-600">
          <i class="fas fa-gift mr-1"></i> Получить бонус
        </button>
        <p id="bonus-feedback" class="bonus-content bonus-feedback hidden mt-2"></p>
      </div>
      <div class="share-container">
        <button onclick="shareApp()" class="bg-blue-500 text-white p-3 rounded-lg hover:bg-blue-600">
          <i class="fas fa-share-alt mr-1"></i> Поделиться приложением
        </button>
        <p id="share-feedback" class="share-message share-feedback hidden mt-2"></p>
      </div>
    </div>
    
    <!-- 7. Оверлей для бонусного сообщения -->
    <div class="overlay" id="overlay"></div>
    
    <!-- 8. Бонусное сообщение -->
    <div class="bonus-message" id="bonusMessage">
      <button class="close-bonus" id="closeBonusMessage" aria-label="Закрыть">
        <i class="fas fa-times"></i>
      </button>
      <h3><i class="fas fa-gift"></i> Ваш мини-бонус!</h3>
      <p id="bonusText"></p>
    </div>
    
    <!-- 9. Кнопки внизу экрана -->
    <div class="bottom-buttons">
      <button id="bonusBtn" class="btn btn-warning" aria-label="Получить бонус">
        <i class="fas fa-envelope"></i> Получить бонус
      </button>
      <button id="shareAppBtn" class="btn btn-info" aria-label="Поделиться приложением">
        <i class="fas fa-share-alt"></i> Поделиться приложением
      </button>
    </div>
  </div>
  
  <!-- 10. Боковая панель для анкеты -->
  <div class="side-panel" id="profilePanel">
    <button class="close-panel" id="closeProfilePanel" aria-label="Закрыть панель">
      <i class="fas fa-times"></i>
    </button>
    
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <h2><i class="fas fa-user-edit"></i> Анкета</h2>
      <button id="editProfileBtn" class="btn btn-info" style="display: none;">
        <i class="fas fa-edit"></i> Редактировать
      </button>
    </div>
    
    <!-- 11. Прогресс-бар анкеты -->
    <div id="formProgressContainer" class="progress-container">
      <div class="progress-bar" id="formProgressBar" style="width: 33%"></div>
      <div class="progress-steps">
        <div class="step active" id="step1">Личные данные</div>
        <div class="step" id="step2">Астрология</div>
        <div class="step" id="step3">Интересы</div>
      </div>
    </div>
    
    <!-- 12. Форма анкеты -->
    <form id="astroForm" style="display: none;">
      <div class="form-step" id="step1Form">
        <div class="form-group">
          <label for="name"><i class="fas fa-user"></i>Имя:</label>
          <input type="text" id="name" name="name" required aria-required="true" />
          <div class="error-message" id="name-error">Пожалуйста, введите ваше имя</div>
        </div>
        
        <div class="form-group">
          <label for="gender"><i class="fas fa-venus-mars"></i>Пол:</label>
          <select id="gender" name="gender" required aria-required="true">
            <option value="">Выберите</option>
            <option value="м">Мужской</option>
            <option value="ж">Женский</option>        
          </select>
          <div class="error-message" id="gender-error">Пожалуйста, выберите пол</div>
        </div>
        
        <button type="button" class="btn next-step" id="nextStep1">
          Далее <i class="fas fa-arrow-right"></i>
        </button>
      </div>
      
      <div class="form-step" id="step2Form" style="display: none;">
        <div class="form-group">
          <label for="birth_date"><i class="fas fa-calendar-day"></i>Дата рождения:</label>
          <input type="date" id="birth_date" name="birth_date" required aria-required="true" />
          <div class="error-message" id="birth_date-error">Пожалуйста, введите корректную дату</div>
        </div>
        
        <div class="form-group">
          <label for="birth_time"><i class="fas fa-clock"></i>Время рождения (необязательно):</label>
          <input type="time" id="birth_time" name="birth_time" aria-describedby="timeHint" />
          <div class="field-hint" id="timeHint">Формат: чч:мм (24-часовой)</div>
        </div>
        
        <div class="form-group">
          <label for="birth_city"><i class="fas fa-city"></i>Город рождения:</label>
          <input type="text" id="birth_city" name="birth_city" required aria-required="true" />
          <div class="error-message" id="birth_city-error">Пожалуйста, укажите город рождения</div>
        </div>
        
        <div class="form-navigation">
          <button type="button" class="btn prev-step" id="prevStep2">
            <i class="fas fa-arrow-left"></i> Назад
          </button>
          <button type="button" class="btn next-step" id="nextStep2">
            Далее <i class="fas fa-arrow-right"></i>
          </button>
        </div>
      </div>
      
      <div class="form-step" id="step3Form" style="display: none;">
        <div class="form-group">
          <label for="interest"><i class="fas fa-star"></i>Основной интерес:</label>
          <select id="interest" name="interest" required aria-required="true">
            <option value="">Выберите</option>
            <option value="Любовь и отношения">Любовь и отношения</option>
            <option value="Карьера и бизнес">Карьера и бизнес</option>
            <option value="Финансы и инвестиции">Финансы и инвестиции</option>
            <option value="Здоровье и благополучие">Здоровье и благополучие</option>
            <option value="Семья и дети">Семья и дети</option>
            <option value="Личностный рост">Личностный рост</option>
            <option value="Творчество и вдохновение">Творчество и вдохновение</option>
            <option value="Путешествия и переезды">Путешествия и переезды</option>
          </select>
          <div class="error-message" id="interest-error">Пожалуйста, выберите интерес</div>
        </div>
        
        <div class="form-group">
          <label for="relationship"><i class="fas fa-heart"></i>Семейное положение:</label>
          <select id="relationship" name="relationship" required aria-required="true">
            <option value="">Выберите</option>
            <option value="В паре">В отношениях</option>
            <option value="Не в паре">Не в отношениях</option>
            <option value="В поиске">В поиске</option>
          </select>
          <div class="error-message" id="relationship-error">Пожалуйста, укажите семейное положение</div>
        </div>
        
        <div class="form-navigation">
          <button type="button" class="btn prev-step" id="prevStep3">
            <i class="fas fa-arrow-left"></i> Назад
          </button>
          <button type="submit" class="btn btn-success" id="saveProfileBtn">
            <i class="fas fa-save"></i> Сохранить анкету
          </button>
        </div>
      </div>
    </form>
    
    <!-- 13. Просмотр профиля -->
    <div class="profile-view" id="profileView">
      <h3><i class="fas fa-user-circle"></i> Ваши данные</h3>
      <div id="profileData"></div>
    </div>
  </div>
  
  <!-- 14. Панель прогноза -->
  <div class="side-panel" id="forecastPanel">
    <button class="close-panel" id="closeForecastPanel" aria-label="Закрыть панель">
      <i class="fas fa-times"></i>
    </button>
    <div class="forecast-container" id="forecastContainer">
      <div class="forecast-header">
        <h2 id="forecastTitle"><i class="fas fa-crystal-ball"></i> Ваш персональный астропрогноз</h2>
        <p id="forecastDate"></p>
      </div>
      
      <div class="forecast-content" id="forecastContent">
      </div>
      
      <div class="share-buttons">
        <button class="btn telegram-btn" id="shareTelegram" aria-label="Поделиться в Telegram">
          <i class="fab fa-telegram"></i> Telegram
        </button>
        <button class="btn whatsapp-btn" id="shareWhatsApp" aria-label="Поделиться в WhatsApp">
          <i class="fab fa-whatsapp"></i> WhatsApp
        </button>
      </div>
    </div>
  </div>

  <!-- 15. Подключение библиотеки автодополнения -->
  <!-- Блок 15: JavaScript для управления формой, прогнозами, бонусом и шарингом -->
  <script>
    // Показать нужную секцию
    function showSection(sectionId) {
      document.querySelectorAll('.form-section').forEach(section => {
        section.classList.remove('active');
      });
      document.getElementById(sectionId).classList.add('active');
    }

    // Получение бонуса
    function getBonus() {
      const name = localStorage.getItem('name') || 'Друг';
      const bonusText = `Персональный совет для ${name}: Доверяйте интуиции и будьте открыты к возможностям!`;
      const bonusFeedback = document.getElementById('bonus-feedback');
      bonusFeedback.textContent = bonusText;
      bonusFeedback.classList.remove('hidden');
      setTimeout(() => bonusFeedback.classList.add('hidden'), 3000);
    }

    // Поделиться приложением
    function shareApp() {
      const shareText = "Хочу поделиться с тобой этим астроботом — реально интересно! Прогноз на день, месяц, совместимость и ещё куча всего. Вот ссылка: @astropred_bot";
      const shareUrl = "https://t.me/astropred_bot";
      const feedback = document.getElementById('share-feedback');
      if (navigator.share) {
        navigator.share({
          title: 'AstroPred',
          text: shareText,
          url: shareUrl
        }).then(() => {
          feedback.textContent = 'Успешно поделились приложением!';
          feedback.classList.remove('hidden');
          setTimeout(() => feedback.classList.add('hidden'), 3000);
        }).catch(() => {
          feedback.textContent = 'Ошибка при попытке поделиться. Попробуйте через Telegram или WhatsApp.';
          feedback.classList.remove('hidden');
          setTimeout(() => feedback.classList.add('hidden'), 3000);
        });
      } else {
        navigator.clipboard.writeText(shareText + ' ' + shareUrl).then(() => {
          feedback.textContent = 'Текст скопирован в буфер обмена! Вставьте его в мессенджер.';
          feedback.classList.remove('hidden');
          setTimeout(() => feedback.classList.add('hidden'), 3000);
        }).catch(() => {
          feedback.textContent = 'Не удалось скопировать. Используйте: ' + shareText + ' ' + shareUrl;
          feedback.classList.remove('hidden');
          setTimeout(() => feedback.classList.add('hidden'), 5000);
        });
      }
    }

    // Заглушки для остальных функций (добавим позже)
    function nextStep(step) { console.log('Next step:', step); }
    function prevStep(step) { console.log('Prev step:', step); }
    function validateStep1() { return true; }
    function validateStep2() { return true; }
    function saveForm() { console.log('Form saved'); }
    function showFormData() { console.log('Showing form data'); }
    function editForm() { console.log('Editing form'); }
  </script>

  <!-- 16. Основной JavaScript код -->
  <script>
    // 16.1 Инициализация WebApp Telegram
    const tg = window.Telegram.WebApp;
    if (tg) {
      tg.expand();
      tg.enableClosingConfirmation();
    }
    
    // 16.2 Основные элементы
    const mainMenu = document.getElementById('mainMenu');
    const profileBtn = document.getElementById('profileBtn');
    const dailyForecastBtn = document.getElementById('dailyForecastBtn');
    const weeklyForecastBtn = document.getElementById('weeklyForecastBtn');
    const monthlyForecastBtn = document.getElementById('monthlyForecastBtn');
    const shareAppBtn = document.getElementById('shareAppBtn');
    const bonusBtn = document.getElementById('bonusBtn');
    const bonusMessage = document.getElementById('bonusMessage');
    const bonusText = document.getElementById('bonusText');
    const closeBonusMessage = document.getElementById('closeBonusMessage');
    const overlay = document.getElementById('overlay');
    const themeToggle = document.getElementById('themeToggle');
    
    // 16.3 Панели
    const profilePanel = document.getElementById('profilePanel');
    const forecastPanel = document.getElementById('forecastPanel');
    
    // 16.4 Кнопки закрытия панелей
    const closeProfilePanel = document.getElementById('closeProfilePanel');
    const closeForecastPanel = document.getElementById('closeForecastPanel');
    
    // 16.5 Форма анкеты
    const profileForm = document.getElementById('astroForm');
    const saveProfileBtn = document.getElementById('saveProfileBtn');
    const profileView = document.getElementById('profileView');
    const profileData = document.getElementById('profileData');
    const editProfileBtn = document.getElementById('editProfileBtn');
    const formProgressContainer = document.getElementById('formProgressContainer');
    
    // 16.6 Прогноз
    const forecastContent = document.getElementById('forecastContent');
    const forecastDate = document.getElementById('forecastDate');
    const forecastTitle = document.getElementById('forecastTitle');
    
    // 16.7 Прогресс-бар анкеты
    const formProgressBar = document.getElementById('formProgressBar');
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const step3 = document.getElementById('step3');
    
    // 16.8 Шаги анкеты
    const step1Form = document.getElementById('step1Form');
    const step2Form = document.getElementById('step2Form');
    const step3Form = document.getElementById('step3Form');
    
    // 16.9 Навигация по шагам
    const nextStep1 = document.getElementById('nextStep1');
    const nextStep2 = document.getElementById('nextStep2');
    const prevStep2 = document.getElementById('prevStep2');
    const prevStep3 = document.getElementById('prevStep3');
    
    // 16.10 Мотивирующие фразы для бонуса
    const bonusPhrases = [
      "Солнышко, сегодня твой день! Звезды сложились в твою пользу — действуй смело!",
      "Родной человек, сегодня Вселенная шепчет: ты сильнее, чем думаешь! Верь в себя!",
      "Любимое сердце, сегодняшний день — твой шанс! Не упусти возможность сделать шаг к мечте!",
      "Близкий мой, звезды говорят — сегодня день маленьких чудес. Будь открыт к сюрпризам!",
      "Теплый свет, твоя энергия сегодня на высоте! Используй этот день для важных дел!",
      "Сокровище, сегодня идеальный момент для новых начинаний. Дерзай!",
      "Радость моя, сегодня твоя интуиция особенно сильна. Доверься внутреннему голосу!",
      "Ангелочек, помни — даже маленькие шаги приводят к большим целям. Ты молодец!",
      "Звездочка, сегодня день магии и возможностей. Верь в чудеса — они рядом!",
      "Солнышко, твои мечты ближе, чем кажется. Продолжай идти — ты на верном пути!"
    ];
    
    // 16.11 Время последнего бонуса
    const BONUS_COOLDOWN = 1 * 60 * 60 * 1000; // 3 часа в миллисекундах
    let lastBonusTime = parseInt(localStorage.getItem('lastBonusTime')) || 0;
    
    // 16.12 Создание звездного фона
    function createStars() {
      const starsCount = 200;
      const containerWidth = window.innerWidth;
      const containerHeight = window.innerHeight;
      
      for (let i = 0; i < starsCount; i++) {
        const star = document.createElement('div');
        star.classList.add('star');
        
        const size = Math.random() * 3;
        const x = Math.random() * containerWidth;
        const y = Math.random() * containerHeight;
        const duration = 2 + Math.random() * 3 + 's';
        const delay = Math.random() * 5 + 's';
        
        star.style.width = `${size}px`;
        star.style.height = `${size}px`;
        star.style.left = `${x}px`;
        star.style.top = `${y}px`;
        star.style.setProperty('--duration', duration);
        star.style.animationDelay = delay;
        
        document.getElementById('stars-container').appendChild(star);
      }
    }
    
    // 16.13 Определение знака зодиака по дате рождения
    function getZodiacSign(dateString) {
      if (!dateString) return '';
      
      const date = new Date(dateString);
      const day = date.getDate();
      const month = date.getMonth() + 1;
      
      if ((month == 3 && day >= 21) || (month == 4 && day <= 19)) return 'Овен';
      if ((month == 4 && day >= 20) || (month == 5 && day <= 20)) return 'Телец';
      if ((month == 5 && day >= 21) || (month == 6 && day <= 20)) return 'Близнецы';
      if ((month == 6 && day >= 21) || (month == 7 && day <= 22)) return 'Рак';
      if ((month == 7 && day >= 23) || (month == 8 && day <= 22)) return 'Лев';
      if ((month == 8 && day >= 23) || (month == 9 && day <= 22)) return 'Дева';
      if ((month == 9 && day >= 23) || (month == 10 && day <= 22)) return 'Весы';
      if ((month == 10 && day >= 23) || (month == 11 && day <= 21)) return 'Скорпион';
      if ((month == 11 && day >= 22) || (month == 12 && day <= 21)) return 'Стрелец';
      if ((month == 12 && day >= 22) || (month == 1 && day <= 19)) return 'Козерог';
      if ((month == 1 && day >= 20) || (month == 2 && day <= 18)) return 'Водолей';
      if ((month == 2 && day >= 19) || (month == 3 && day <= 20)) return 'Рыбы';
      
      return '';
    }
    
    // 16.14 Получение гороскопа через альтернативное API (работающее в России)
    async function getHoroscope(zodiacSign, period = 'today') {
      try {
        // Преобразуем русское название знака в английское для API
        const zodiacMap = {
          'Овен': 'aries',
          'Телец': 'taurus',
          'Близнецы': 'gemini',
          'Рак': 'cancer',
          'Лев': 'leo',
          'Дева': 'virgo',
          'Весы': 'libra',
          'Скорпион': 'scorpio',
          'Стрелец': 'sagittarius',
          'Козерог': 'capricorn',
          'Водолей': 'aquarius',
          'Рыбы': 'pisces'
        };
    
        const sign = zodiacMap[zodiacSign] || 'aries';
        const API_KEY = 'your-api-key'; // Должен быть заменен на реальный ключ
    
        // Используем альтернативное API, работающее в России
        const response = await fetch(`https://horoscopes-ai.p.rapidapi.com/get_horoscope/${period}/${sign}/ru`, {
          method: 'GET',
          headers: {
            'X-RapidAPI-Key': API_KEY,
            'X-RapidAPI-Host': 'horoscopes-ai.p.rapidapi.com'
          },
          signal: AbortSignal.timeout(5000) // Таймаут 5 секунд
        });

        if (!response.ok) {
          throw new Error(`Ошибка API: ${response.status}`);
        }

        const data = await response.json();
    
        if (!data?.horoscope) {
          throw new Error('Неверный формат ответа от API');
        }

        return {
          description: data.horoscope,
          date: new Date().toLocaleDateString('ru-RU')
        };
      } catch (error) {
        console.error('Ошибка получения гороскопа:', error);
        // Возвращаем локально сохраненные прогнозы, если API недоступно
        return getLocalHoroscope(zodiacSign, period);
      }
    }
    // 16.15 Локальные прогнозы (используются, если API недоступно)
    function getLocalHoroscope(zodiacSign, period) {
      const forecasts = {
        'Овен': {
          today: "Сегодня звезды благоволят Овнам. Это отличный день для новых начинаний и смелых решений.",
          week: "На этой неделе Овнам стоит проявить инициативу. Возможны неожиданные повороты событий.",
          month: "Этот месяц принесет Овнам важные изменения. Будьте готовы к новым возможностям."
        },
        'Телец': {
          today: "Сегодня Тельцам стоит проявить терпение. Избегайте поспешных решений.",
          week: "На этой неделе Тельцы могут рассчитывать на стабильность. Хорошее время для финансовых операций.",
          month: "Этот месяц будет продуктивным для Тельцов. Сосредоточьтесь на долгосрочных целях."
        },
        // Добавьте прогнозы для остальных знаков...
      };

      const periodMap = {
        'today': 'today',
        'day': 'today',
        'week': 'week',
        'month': 'month'
      };

      const periodKey = periodMap[period] || 'today';
      const defaultForecast = "Сегодня благоприятный день. Прислушивайтесь к своей интуиции.";

      return {
        description: forecasts[zodiacSign]?.[periodKey] || defaultForecast,
        date: new Date().toLocaleDateString('ru-RU')
      };
    }

    // 16.16 Показать боковую панель
    function showPanel(panel) {
      // Если панель уже открыта - ничего не делаем
      if (panel.classList.contains('active')) return;
  
      // Сначала скрываем все панели
      document.querySelectorAll('.side-panel').forEach(p => {
        p.classList.remove('active');
      });
  
      // Затем показываем нужную панель с анимацией
      panel.style.transition = 'none';
      panel.style.right = `-${panel.offsetWidth}px`;
      panel.style.display = 'block';
  
      requestAnimationFrame(() => {
        panel.style.transition = `right ${getComputedStyle(panel).getPropertyValue('--transition-speed')} ease`;
        panel.classList.add('active');
        document.body.classList.add('panel-open');
      });
    }
    // 16.17 Скрыть все боковые панели
    function hideAllPanels() {
      document.querySelectorAll('.side-panel').forEach(panel => {
        panel.classList.remove('active');
      });
      document.body.classList.remove('panel-open');
    }
    
    // 16.18 Обновление прогресс-бара анкеты
    function updateProgress(currentStep) {
      const progress = (currentStep / 3) * 100;
      formProgressBar.style.width = `${progress}%`;
      
      step1.classList.remove('active', 'completed');
      step2.classList.remove('active', 'completed');
      step3.classList.remove('active', 'completed');
      
      if (currentStep >= 1) step1.classList.add('completed');
      if (currentStep >= 2) step2.classList.add('completed');
      if (currentStep >= 3) step3.classList.add('completed');
      
      document.getElementById(`step${currentStep}`).classList.add('active');
    }
    
    // 16.19 Переход к следующему шагу анкеты
    function goToNextStep(currentStep, nextStep) {
      const currentForm = document.getElementById(`step${currentStep}Form`);
      const inputs = currentForm.querySelectorAll('input, select');

      for (let field of inputs) {
        if (!field.checkValidity()) {
          field.reportValidity();
          return;
        }
      }

      currentForm.style.display = 'none';
      document.getElementById(`step${nextStep}Form`).style.display = 'block';
      updateProgress(nextStep);
      profilePanel.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // 16.20 Переход к предыдущему шагу анкеты
    function goToPrevStep(currentStep, prevStep) {
      document.getElementById(`step${currentStep}Form`).style.display = 'none';
      document.getElementById(`step${prevStep}Form`).style.display = 'block';
      updateProgress(prevStep);
      profilePanel.scrollTo({ top: 0, behavior: 'smooth' });
    }
    

    // 16.21 Генерация прогноза на основе данных
    async function generateForecast(data, period = 'день') {
      try {
        const zodiac = getZodiacSign(data.birth_date);
    
        if (!zodiac) {
          return '<p>Не удалось определить знак зодиака. Пожалуйста, проверьте дату рождения.</p>';
        }
    
        // Проверяем кэш
        const cacheKey = `${zodiac}-${period}-${new Date().toLocaleDateString()}`;
        const cached = sessionStorage.getItem(cacheKey);
    
        if (cached) {
          return cached;
        }
    
        // Определяем период для API
        let apiPeriod = 'today';
        if (period === 'неделю') apiPeriod = 'week';
        if (period === 'месяц') apiPeriod = 'month';
    
        // Получаем гороскоп
        const horoscope = await getHoroscope(zodiac, apiPeriod);
    
        if (!horoscope) {
          return '<p>Не удалось получить прогноз. Пожалуйста, попробуйте позже.</p>';
        }
    
        // Формируем HTML прогноза
        let forecastHTML = `
          <div class="forecast-section">
            <h3><i class="fas fa-user-astronaut"></i> Персональные данные</h3>
            <p>Имя: ${data.name}</p>
            <p>Знак зодиака: ${zodiac}</p>
            <p>Интерес: ${data.interest}</p>
          </div>
      
          <div class="forecast-section">
            <h3><i class="fas fa-star"></i> Основной прогноз</h3>
            <p>${horoscope.description}</p>
        `;
    
        if (period === 'день') {
          forecastHTML += `
            <p><strong>Дата прогноза:</strong> ${horoscope.date}</p>
          `;
        }
    
        forecastHTML += `</div>`;
    
        // Добавляем персонализированные рекомендации
        forecastHTML += `
          <div class="forecast-section">
            <h3><i class="fas fa-lightbulb"></i> Персональные рекомендации</h3>
            <p>${getPersonalAdvice(data, horoscope, period)}</p>
          </div>
        `;
    
        // Сохраняем в кэш
        sessionStorage.setItem(cacheKey, forecastHTML);
    
        // Устанавливаем заголовок прогноза
        forecastTitle.innerHTML = `<i class="fas fa-crystal-ball"></i> Ваш персональный астропрогноз на ${period}`;
    
        return forecastHTML;
      } catch (error) {
        console.error('Ошибка генерации прогноза:', error);
        return '<p>Произошла ошибка при формировании прогноза. Пожалуйста, попробуйте позже.</p>';
      }
    }
    // 16.22 Генерация персонализированных рекомендаций
    function getPersonalAdvice(data, horoscope, period) {
      let advice = '';
      
      if (data.interest === 'Любовь и отношения') {
        if (data.relationship === 'В паре') {
          advice = `В этот ${period} звезды рекомендуют уделить больше внимания партнеру. Хорошее время для ваших отношений.`;
        } else {
          advice = `Этот ${period} благоприятен для новых знакомств. Будьте открыты для новых встреч.`;
        }
      } 
      else if (data.interest === 'Карьера и бизнес') {
        advice = `Профессиональная сфера: ${horoscope.description.split('.')[0]}. Используйте этот ${period} для важных переговоров.`;
      }
      else if (data.interest === 'Финансы и инвестиции') {
        advice = `Финансовая удача сегодня зависит от ваших решений. ${horoscope.description.split('.')[0] || 'Звезды советуют быть внимательнее.'}`;
      }
      else {
        advice = `Для вас в этот ${period}: ${horoscope.description.split('.')[0]}. Следуйте своей интуиции.`;
      }
      
      return advice;
    }
    
    // 16.23 Показать уведомление
    function showNotification(message, type = 'success') {
      // Удаляем предыдущие уведомления того же типа
      document.querySelectorAll(`.notification.${type}`).forEach(el => el.remove());
  
      const icons = {
        success: 'fa-check-circle',
        error: 'fa-exclamation-circle',
        info: 'fa-info-circle',
        warning: 'fa-exclamation-triangle'
      };
  
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.innerHTML = `
        <i class="fas ${icons[type] || 'fa-info-circle'}"></i>
        <span>${message}</span>
      `;
  
      document.body.appendChild(notification);
  
      // Автоматическое скрытие через 3 секунды
      setTimeout(() => {
        notification.classList.add('fade-out');
        setTimeout(() => {
          notification.remove();
        }, 300);
      }, 3000);
    }
    
    // 16.24 Отображение данных профиля
    function displayProfileData(data) {
      if (!data || !data.name) {
        profileData.innerHTML = '<p>Анкета еще не заполнена.</p>';
        return;
      }
      
      const zodiac = getZodiacSign(data.birth_date);
      
      profileData.innerHTML = `
        <p><strong>Имя:</strong> ${data.name}</p>
        <p><strong>Пол:</strong> ${data.gender === 'м' ? 'Мужской' : 'Женский'}</p>
        <p><strong>Дата рождения:</strong> ${new Date(data.birth_date).toLocaleDateString('ru-RU')}</p>
        ${data.birth_time ? `<p><strong>Время рождения:</strong> ${data.birth_time}</p>` : ''}
        <p><strong>Город рождения:</strong> ${data.birth_city}</p>
        <p><strong>Знак зодиака:</strong> ${zodiac || 'Не определен'}</p>
        <p><strong>Основной интерес:</strong> ${data.interest}</p>
        <p><strong>Семейное положение:</strong> ${data.relationship}</p>
      `;
    }
    
    // 16.25 Переключение между режимами просмотра и редактирования анкеты
    function toggleProfileViewMode(editMode = false) {
      if (editMode) {
        // Режим редактирования
        profileView.style.display = 'none';
        profileForm.style.display = 'block';
        formProgressContainer.style.display = 'block';
        editProfileBtn.style.display = 'none';
        
        // Показываем первый шаг формы
        step1Form.style.display = 'block';
        step2Form.style.display = 'none';
        step3Form.style.display = 'none';
        updateProgress(1);
      } else {
        // Режим просмотра
        profileView.style.display = 'block';
        profileForm.style.display = 'none';
        formProgressContainer.style.display = 'none';
        
        // Показываем кнопку редактирования, если есть данные
        const savedData = localStorage.getItem('astroProfileData');
        editProfileBtn.style.display = savedData ? 'block' : 'none';
      }
    }
    
    // 16.26 Показать случайный бонус
    function showRandomBonus() {
      const now = Date.now();
      const timeLeft = lastBonusTime + BONUS_COOLDOWN - now;
      
      if (timeLeft > 0) {
        const hoursLeft = Math.ceil(timeLeft / (60 * 60 * 1000));
        showNotification(`Вы сможете получить новый бонус через ${hoursLeft} часа(ов)`, 'error');
        return;
      }
      
      const randomIndex = Math.floor(Math.random() * bonusPhrases.length);
      bonusText.textContent = bonusPhrases[randomIndex];
      
      // Показываем оверлей и сообщение
      overlay.style.display = 'block';
      bonusMessage.style.display = 'block';
      
      // Сохраняем время получения бонуса
      lastBonusTime = now;
      localStorage.setItem('lastBonusTime', lastBonusTime);
      
      // Обновляем состояние кнопки
      updateBonusButton();
    }
    
    // 16.27 Обновить состояние кнопки бонуса
    function updateBonusButton() {
      const now = Date.now();
      const timeLeft = lastBonusTime + BONUS_COOLDOWN - now;
      
      if (timeLeft > 0) {
        const hoursLeft = Math.ceil(timeLeft / (60 * 60 * 1000));
        bonusBtn.innerHTML = `<i class="fas fa-clock"></i> До бонуса: ${hoursLeft}ч`;
        bonusBtn.disabled = true;
      } else {
        bonusBtn.innerHTML = '<i class="fas fa-gift"></i> Получить бонус';
        bonusBtn.disabled = false;
      }
    }
    
    // 16.28 Переключение темы (светлая/тёмная) с иконкой
    function toggleTheme() {
      const root = document.documentElement;
      const isLight = root.classList.toggle('light-theme');
      localStorage.setItem('theme', isLight ? 'light' : 'dark');

      // Добавляем класс для анимации
      document.body.classList.add('theme-changing');
      setTimeout(() => {
        document.body.classList.remove('theme-changing');
      }, 300);

      // Обновляем иконку
      const themeIcon = document.getElementById('themeIcon');
      if (themeIcon) {
        themeIcon.innerHTML = isLight
          ? '<i class="fas fa-sun"></i>'
          : '<i class="fas fa-moon"></i>';
      }
    }
    
    // 16.29 Инициализация приложения
    function initApp() {
      try {
        // Сначала применяем сохранённую тему
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'light') {
          document.documentElement.classList.add('light-theme');
        }

        // Затем создаём звёзды (с учётом темы)
        createStars();

        // Проверяем, есть ли сохранённые данные анкеты
        const savedData = localStorage.getItem('astroProfileData');
        if (savedData) {
          try {
            const data = JSON.parse(savedData);
        
            // Проверяем, что данные валидны
            if (data && data.name && data.birth_date) {
              // Заполняем форму сохранёнными данными
              for (const key in data) {
                if (profileForm.elements[key]) {
                  profileForm.elements[key].value = data[key];
                }
              }

              // Показываем данные в режиме просмотра
              displayProfileData(data);
              toggleProfileViewMode(false);
            } else {
              // Если данные невалидны - открываем форму
              toggleProfileViewMode(true);
              localStorage.removeItem('astroProfileData');
            }
          } catch (e) {
            console.error('Ошибка парсинга данных:', e);
            toggleProfileViewMode(true);
            localStorage.removeItem('astroProfileData');
          }
        } else {
          // Если данных нет — открываем форму
          toggleProfileViewMode(true);
        }

        // Инициализация автодополнения для города
        if (document.getElementById('birth_city')) {
          new Awesomplete(document.getElementById('birth_city'), {
            list: ['Москва', 'Санкт-Петербург', 'Новосибирск', 'Екатеринбург', 'Казань', 'Нижний Новгород', 
                   'Челябинск', 'Самара', 'Омск', 'Ростов-на-Дону', 'Уфа', 'Красноярск', 'Пермь', 'Воронеж', 
                   'Волгоград', 'Краснодар', 'Саратов', 'Тюмень', 'Тольятти', 'Ижевск', 'Барнаул', 'Ульяновск'],
            minChars: 1,
            maxItems: 10
          });
        }

        // Обновляем состояние кнопки бонуса
        updateBonusButton();
      } catch (error) {
        console.error('Ошибка инициализации:', error);
        // Показываем сообщение об ошибке
        showNotification('Произошла ошибка при загрузке приложения', 'error');
      }
    }

    // 16.30 Обработчики событий
    profileBtn.addEventListener('click', () => {
      showPanel(profilePanel);
      
      // Проверяем, есть ли сохраненные данные
      const savedData = localStorage.getItem('astroProfileData');
      if (savedData) {
        // Если есть - показываем режим просмотра
        toggleProfileViewMode(false);
      } else {
        // Если нет - показываем форму для заполнения
        toggleProfileViewMode(true);
      }
    });
    
    // Обработчик кнопки редактирования профиля
    editProfileBtn.addEventListener('click', () => {
      toggleProfileViewMode(true);
    });
    
    dailyForecastBtn.addEventListener('click', async () => {
      const savedData = localStorage.getItem('astroProfileData');
      if (!savedData) {
        showNotification('Пожалуйста, сначала заполните анкету', 'error');
        showPanel(profilePanel);
        return;
      }
      
      const data = JSON.parse(savedData);
      
      // Показываем индикатор загрузки
      dailyForecastBtn.disabled = true;
      dailyForecastBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Загрузка...';
      
      forecastContent.innerHTML = await generateForecast(data, 'день');
      forecastDate.textContent = `Прогноз на ${new Date().toLocaleDateString('ru-RU')}`;
      showPanel(forecastPanel);
      
      // Возвращаем кнопку в исходное состояние
      dailyForecastBtn.disabled = false;
      dailyForecastBtn.innerHTML = '<i class="fas fa-sun"></i> Прогноз на день';
    });
    
    weeklyForecastBtn.addEventListener('click', async () => {
      const savedData = localStorage.getItem('astroProfileData');
      if (!savedData) {
        showNotification('Пожалуйста, сначала заполните анкету', 'error');
        showPanel(profilePanel);
        return;
      }
      
      const data = JSON.parse(savedData);
      
      // Показываем индикатор загрузки
      weeklyForecastBtn.disabled = true;
      weeklyForecastBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Загрузка...';
      
      forecastContent.innerHTML = await generateForecast(data, 'неделю');
      forecastDate.textContent = `Прогноз на неделю ${new Date().toLocaleDateString('ru-RU', { month: 'long', year: 'numeric' })}`;
      showPanel(forecastPanel);
      
      // Возвращаем кнопку в исходное состояние
      weeklyForecastBtn.disabled = false;
      weeklyForecastBtn.innerHTML = '<i class="fas fa-calendar-week"></i> Прогноз на неделю';
    });
    
    monthlyForecastBtn.addEventListener('click', async () => {
      const savedData = localStorage.getItem('astroProfileData');
      if (!savedData) {
        showNotification('Пожалуйста, сначала заполните анкету', 'error');
        showPanel(profilePanel);
        return;
      }
      
      const data = JSON.parse(savedData);
      
      // Показываем индикатор загрузки
      monthlyForecastBtn.disabled = true;
      monthlyForecastBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Загрузка...';
      
      forecastContent.innerHTML = await generateForecast(data, 'месяц');
      forecastDate.textContent = `Прогноз на месяц ${new Date().toLocaleDateString('ru-RU', { month: 'long', year: 'numeric' })}`;
      showPanel(forecastPanel);
      
      // Возвращаем кнопку в исходное состояние
      monthlyForecastBtn.disabled = false;
      monthlyForecastBtn.innerHTML = '<i class="fas fa-calendar-alt"></i> Прогноз на месяц';
    });
    
    // Обработчики закрытия панелей
    closeProfilePanel.addEventListener('click', hideAllPanels);
    closeForecastPanel.addEventListener('click', hideAllPanels);
    
    // Обработчики шагов анкеты
    nextStep1.addEventListener('click', () => goToNextStep(1, 2));
    nextStep2.addEventListener('click', () => goToNextStep(2, 3));
    prevStep2.addEventListener('click', () => goToPrevStep(2, 1));
    prevStep3.addEventListener('click', () => goToPrevStep(3, 2));
    
    // Обработка сохранения анкеты
    profileForm.addEventListener('submit', (e) => {
      e.preventDefault();
      
      if (!profileForm.checkValidity()) {
        showNotification('Пожалуйста, заполните все обязательные поля', 'error');
        return;
      }
      
      const formData = new FormData(profileForm);
      const data = Object.fromEntries(formData.entries());
      
      // Сохраняем данные в localStorage
      localStorage.setItem('astroProfileData', JSON.stringify(data));
      
      // Показываем данные профиля
      displayProfileData(data);
      
      // Переключаемся в режим просмотра
      toggleProfileViewMode(false);
      
      // Показываем уведомление об успешном сохранении
      showNotification('Анкета успешно сохранена', 'success');
    });
    
    // Поделиться через Telegram
    document.getElementById('shareTelegram').addEventListener('click', () => {
      const text = `Мой астропрогноз на сегодня:\n${forecastContent.textContent.substring(0, 200)}...\n\nПолный прогноз в приложении AstroPred!`;
      if (tg && tg.isTelegram) {
        tg.sendData(text);
      } else {
        const url = `https://t.me/share/url?url=${encodeURIComponent(window.location.href)}&text=${encodeURIComponent(text)}`;
        window.open(url, '_blank');
      }
    });
    
    // Поделиться через WhatsApp
    document.getElementById('shareWhatsApp').addEventListener('click', () => {
      const text = `Мой астропрогноз на сегодня:\n${forecastContent.textContent.substring(0, 200)}...\n\nПолный прогноз в приложении AstroPred!`;
      const url = `https://wa.me/?text=${encodeURIComponent(text + '\n\n' + window.location.href)}`;
      window.open(url, '_blank');
    });
    
    // Поделиться приложением
    shareAppBtn.addEventListener('click', () => {
      // Генерируем случайный реферальный код
      const refCode = 'ref' + Math.floor(1000 + Math.random() * 9000);
      const shareUrl = `https://t.me/astropred_bot?start=${refCode}`;

      if (navigator.share) {
        navigator.share({
          title: 'AstroPred — Астрологический помощник',
          text: 'Попробуй AstroPred — это работает магически ✨',
          url: shareUrl
        }).catch(console.error);
      } else if (tg && tg.isTelegram) {
        tg.sendData(shareUrl);
      } else {
        navigator.clipboard.writeText(shareUrl)
          .then(() => showNotification('Ссылка скопирована в буфер обмена!', 'success'))
          .catch(() => showNotification(`Ссылка для приглашения: ${shareUrl}`, 'info'));
      }
    });
    
    // Показать бонусное сообщение
    bonusBtn.addEventListener('click', showRandomBonus);
    
    // Закрыть бонусное сообщение
    closeBonusMessage.addEventListener('click', () => {
      overlay.style.display = 'none';
      bonusMessage.style.display = 'none';
    });
    
    // Закрыть бонусное сообщение при клике на оверлей
    overlay.addEventListener('click', () => {
      overlay.style.display = 'none';
      bonusMessage.style.display = 'none';
    });
    
    // Переключение темы по клику на логотип
    themeToggle.addEventListener('click', toggleTheme);
    
    // Запуск приложения
    window.addEventListener('load', initApp);
  </script>
</body>
</html>
