```html
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AstroPred Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.css">
  <style>
    :root {
      --primary-color: #9370db;
      --secondary-color: #6a5acd;
      --text-color: #f0f0f0;
      --bg-color: #0a0a1a;
      --card-color: rgba(22, 33, 62, 0.8);
      --error-color: #ff6b6b;
      --success-color: #4caf50;
    }
    
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      color: var(--text-color);
      padding: 20px;
      transition: all 0.3s ease;
      position: relative;
      overflow-x: hidden;
      min-height: 100vh;
      background: var(--bg-color);
    }
    
    /* Оптимизированный звездный фон */
    #stars-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      overflow: hidden;
      will-change: transform;
      contain: strict;
    }
    
    .star {
      position: absolute;
      background-color: #fff;
      border-radius: 50%;
      animation: twinkle var(--duration) infinite ease-in-out;
      will-change: opacity;
      backface-visibility: hidden;
    }
    
    @keyframes twinkle {
      0%, 100% { opacity: 0.2; }
      50% { opacity: 1; }
    }
    
    h1 {
      text-align: center;
      margin-bottom: 20px;
      color: var(--primary-color);
    }
    
    .theme-switch {
      position: absolute;
      top: 20px;
      right: 20px;
      cursor: pointer;
      z-index: 10;
      color: var(--primary-color);
      background: rgba(0,0,0,0.3);
      padding: 8px;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    form {
      display: flex;
      flex-direction: column;
      gap: 15px;
      background: var(--card-color);
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
      transition: all 0.3s ease;
      backdrop-filter: blur(5px);
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .form-group {
      position: relative;
      animation: fadeIn 0.5s ease forwards;
      opacity: 0;
    }
    
    label {
      font-weight: 600;
      display: block;
      margin-bottom: 8px;
      color: var(--text-color);
    }
    
    label i {
      margin-right: 8px;
      color: var(--primary-color);
      width: 20px;
      text-align: center;
    }
    
    .field-hint {
      font-size: 12px;
      color: var(--primary-color);
      margin-top: 4px;
      font-style: italic;
    }
    
    input, select, button, textarea {
      padding: 12px 15px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.2);
      font-size: 16px;
      width: 100%;
      box-sizing: border-box;
      background: rgba(0,0,0,0.3);
      color: var(--text-color);
      transition: all 0.3s ease;
    }
    
    input:focus, select:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(106, 90, 205, 0.3);
      outline: none;
    }
    
    input:invalid, select:invalid {
      border-color: var(--error-color);
    }
    
    button {
      background-color: var(--primary-color);
      color: #fff;
      border: none;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      margin-top: 10px;
      padding: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    button:hover {
      background-color: var(--secondary-color);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    button:disabled {
      background-color: #555;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .loader {
      display: none;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
    }
    
    @keyframes spin {
      to { transform: translateY(-50%) rotate(360deg); }
    }
    
    .error-message {
      color: var(--error-color);
      font-size: 13px;
      margin-top: 5px;
      display: none;
    }
    
    .success-message {
      color: var(--success-color);
      text-align: center;
      margin-top: 15px;
      display: none;
    }
    
    .example-reports {
      display: none;
      margin-top: 20px;
      padding: 15px;
      background: rgba(106, 90, 205, 0.2);
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .language-switcher {
      position: absolute;
      top: 20px;
      left: 20px;
      z-index: 10;
      background: rgba(0,0,0,0.3);
      padding: 5px;
      border-radius: 8px;
    }
    
    .recommendations {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px dashed rgba(255,255,255,0.2);
    }
    
    .recommendations label {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      font-weight: normal;
      cursor: pointer;
    }
    
    .recommendations input[type="checkbox"] {
      width: auto;
      margin-right: 10px;
    }
    
    /* Анимации */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Прогноз */
    .forecast-container {
      display: none;
      background: var(--card-color);
      padding: 25px;
      border-radius: 15px;
      margin-top: 20px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
      backdrop-filter: blur(5px);
      border: 1px solid rgba(255,255,255,0.1);
      animation: slideUp 0.5s ease forwards;
    }
    
    .forecast-header {
      text-align: center;
      margin-bottom: 20px;
      color: var(--primary-color);
    }
    
    .forecast-content {
      line-height: 1.6;
    }
    
    .forecast-section {
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px dashed rgba(255,255,255,0.1);
    }
    
    .forecast-section h3 {
      color: var(--primary-color);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    /* Анимация появления прогноза */
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Стиль для отображения знака зодиака */
    .zodiac-display {
      display: inline-block;
      margin-left: 10px;
      padding: 5px 10px;
      background: rgba(106, 90, 205, 0.3);
      border-radius: 15px;
      font-size: 14px;
      color: var(--primary-color);
    }
    
    /* Стиль для сообщения о консультации */
    .consultation-message {
      display: none;
      margin-top: 15px;
      padding: 10px;
      background: rgba(106, 90, 205, 0.2);
      border-radius: 10px;
      text-align: center;
      color: var(--text-color);
    }
    
    /* Совместимость */
    .compatibility-container {
      display: none;
      background: var(--card-color);
      padding: 25px;
      border-radius: 15px;
      margin-top: 20px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
      backdrop-filter: blur(5px);
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .compatibility-result {
      margin-top: 15px;
      padding: 15px;
      background: rgba(106, 90, 205, 0.2);
      border-radius: 10px;
    }
    
    .compatibility-meter {
      height: 20px;
      background: rgba(0,0,0,0.3);
      border-radius: 10px;
      margin: 10px 0;
      overflow: hidden;
    }
    
    .compatibility-progress {
      height: 100%;
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
      width: 0;
      transition: width 1s ease;
    }
    
    /* Адаптация для мобильных */
    @media (max-width: 600px) {
      body {
        padding: 15px;
      }
      
      form {
        padding: 15px;
      }
      
      .theme-switch, .language-switcher {
        position: relative;
        top: auto;
        right: auto;
        left: auto;
        margin-bottom: 15px;
      }
      
      /* Оптимизация анимации для мобильных */
      #stars-container {
        animation: none;
      }
      
      .star {
        animation: none;
        opacity: 0.5;
      }
    }
    
    /* Улучшенные стили для элементов формы */
    input[type="color"] {
      height: 50px;
      padding: 5px;
      cursor: pointer;
    }
    
    /* Стили для уведомлений */
    .notification-banner {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--primary-color);
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      z-index: 100;
      display: none;
      animation: fadeInUp 0.3s ease;
    }
    
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateX(-50%) translateY(20px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }
    
    /* Стили для партнера в анализе совместимости */
    .partner-form {
      display: none;
      margin-top: 15px;
      padding: 15px;
      background: rgba(106, 90, 205, 0.1);
      border-radius: 10px;
      border: 1px dashed rgba(255,255,255,0.1);
    }
    
    /* Стили для иконок загрузки */
    .loading-icon {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s linear infinite;
    }
  </style>
</head>
<body>
  <div id="stars-container"></div>
  
  <div class="theme-switch" id="themeSwitch">
    <i class="fas fa-moon"></i>
  </div>
  
  <div class="language-switcher">
    <select id="languageSelect">
      <option value="ru">Русский</option>
      <option value="en">English</option>
    </select>
  </div>

  <h1 id="formTitle">Астрологический прогноз</h1>
  
  <form id="astroForm">
    <div class="form-group" style="animation-delay: 0.1s">
      <label for="name"><i class="fas fa-user"></i><span data-lang="name">Имя:</span></label>
      <input type="text" id="name" name="name" required />
      <div class="error-message" id="name-error" data-lang="name-error">Пожалуйста, введите ваше имя</div>
    </div>

    <div class="form-group" style="animation-delay: 0.2s">
      <label for="birth_date"><i class="fas fa-calendar-day"></i><span data-lang="birth_date">Дата рождения:</span></label>
      <input type="date" id="birth_date" name="birth_date" required />
      <div class="error-message" id="birth_date-error" data-lang="birth_date-error">Пожалуйста, введите корректную дату</div>
      <div id="zodiacDisplay" class="zodiac-display" style="display: none;"></div>
    </div>

    <div class="form-group" style="animation-delay: 0.3s">
      <label for="birth_time"><i class="fas fa-clock"></i><span data-lang="birth_time">Время рождения (необязательно):</span></label>
      <input type="time" id="birth_time" name="birth_time" />
      <div class="field-hint" data-lang="time_format">Формат: чч:мм (24-часовой)</div>
    </div>

    <div class="form-group" style="animation-delay: 0.4s">
      <label for="birth_city"><i class="fas fa-city"></i><span data-lang="birth_city">Город рождения:</span></label>
      <input type="text" id="birth_city" name="birth_city" required />
      <div class="error-message" id="birth_city-error" data-lang="birth_city-error">Пожалуйста, укажите город рождения</div>
    </div>

    <div class="form-group" style="animation-delay: 0.5s">
      <label for="gender"><i class="fas fa-venus-mars"></i><span data-lang="gender">Пол:</span></label>
      <select id="gender" name="gender" required>
        <option value="" data-lang="select">Выберите</option>
        <option value="м" data-lang="male">Мужской</option>
        <option value="ж" data-lang="female">Женский</option>        
      </select>
      <div class="error-message" id="gender-error" data-lang="gender-error">Пожалуйста, выберите пол</div>
    </div>

    <div class="form-group" style="animation-delay: 0.6s">
      <label for="interest"><i class="fas fa-star"></i><span data-lang="interest">Интерес:</span></label>
      <select id="interest" name="interest" required>
        <option value="" data-lang="select">Выберите</option>
        <option value="Любовь и отношения" data-lang="love">Любовь и отношения</option>
        <option value="Карьера и бизнес" data-lang="career">Карьера и бизнес</option>
        <option value="Финансы и инвестиции" data-lang="finance">Финансы и инвестиции</option>
        <option value="Здоровье и благополучие" data-lang="health">Здоровье и благополучие</option>
        <option value="Семья и дети" data-lang="family">Семья и дети</option>
        <option value="Личностный рост" data-lang="growth">Личностный рост</option>
        <option value="Творчество и вдохновение" data-lang="creativity">Творчество и вдохновение</option>
        <option value="Путешествия и переезды" data-lang="travel">Путешествия и переезды</option>
        <option value="Духовное развитие" data-lang="spiritual">Духовное развитие</option>
        <option value="Образование и обучение" data-lang="education">Образование и обучение</option>
        <option value="Важные решения" data-lang="decisions">Важные решения</option>
        <option value="Общий прогноз" data-lang="general">Общий прогноз</option>
      </select>
      <div class="error-message" id="interest-error" data-lang="interest-error">Пожалуйста, выберите интерес</div>
    </div>

    <div class="form-group" style="animation-delay: 0.7s">
      <label for="relationship"><i class="fas fa-heart"></i><span data-lang="relationship">Семейное положение:</span></label>
      <select id="relationship" name="relationship" required>
        <option value="" data-lang="select">Выберите</option>
        <option value="В паре" data-lang="in_relationship">В отношениях</option>
        <option value="Не в паре" data-lang="not_in_relationship">Не в отношениях</option>
        <option value="В поиске" data-lang="searching">В поиске</option>
        <option value="В сложных отношениях" data-lang="complicated">В сложных отношениях</option>
      </select>
      <div class="error-message" id="relationship-error" data-lang="relationship-error">Пожалуйста, укажите семейное положение</div>
    </div>

    <div class="form-group" style="animation-delay: 0.8s">
      <label for="children"><i class="fas fa-baby"></i><span data-lang="children">Есть ли дети:</span></label>
      <select id="children" name="children" required>
        <option value="" data-lang="select">Выберите</option>
        <option value="Да" data-lang="yes">Да</option>
        <option value="Нет" data-lang="no">Нет</option>
        <option value="Планируем" data-lang="planning">Планируем</option>
      </select>
      <div class="error-message" id="children-error" data-lang="children-error">Пожалуйста, укажите, есть ли у вас дети</div>
    </div>

    <div class="form-group" style="animation-delay: 0.9s">
      <label for="favorite_color"><i class="fas fa-palette"></i><span data-lang="favorite_color">Любимый цвет:</span></label>
      <input type="color" id="favorite_color" name="favorite_color" value="#6a5acd" required />
      <div class="error-message" id="favorite_color-error" data-lang="color-error">Пожалуйста, выберите цвет</div>
    </div>

    <div class="form-group" style="animation-delay: 1.0s">
      <label for="fears"><i class="fas fa-flushed"></i><span data-lang="fears">Страхи или тревоги (необязательно):</span></label>
      <textarea id="fears" name="fears" rows="2"></textarea>
    </div>

    <div class="recommendations">
      <h3><i class="fas fa-gift"></i><span data-lang="extras">Дополнительные возможности:</span></h3>
      <label>
        <input type="checkbox" name="receive_newsletter" id="receiveNewsletter">
        <span data-lang="newsletter">Получать еженедельный астропрогноз</span>
      </label>
      <label>
        <input type="checkbox" name="compatibility_analysis" id="compatibilityAnalysis">
        <span data-lang="compatibility_analysis">Анализ совместимости с партнером</span>
      </label>
      
      <div id="partnerForm" class="partner-form">
        <h4><i class="fas fa-user-friends"></i><span data-lang="partner_data">Данные партнера</span></h4>
        <div class="form-group">
          <label for="partner_name"><i class="fas fa-user"></i><span data-lang="partner_name">Имя партнера:</span></label>
          <input type="text" id="partner_name" name="partner_name" />
          <div class="error-message" id="partner_name-error" data-lang="partner_name-error">Пожалуйста, введите имя партнера</div>
        </div>
        <div class="form-group">
          <label for="partner_birth_date"><i class="fas fa-calendar-day"></i><span data-lang="partner_birth_date">Дата рождения партнера:</span></label>
          <input type="date" id="partner_birth_date" name="partner_birth_date" />
          <div class="error-message" id="partner_birth_date-error" data-lang="partner_birth_date-error">Пожалуйста, введите корректную дату</div>
          <div id="partnerZodiacDisplay" class="zodiac-display" style="display: none;"></div>
        </div>
      </div>
    </div>

    <button type="submit" id="submitBtn" style="animation-delay: 1.1s">
      <i class="fas fa-paper-plane"></i><span data-lang="get_forecast">Получить прогноз</span>
      <span class="loader" id="loader"></span>
    </button>
  </form>

  <div class="forecast-container" id="forecastContainer">
    <div class="forecast-header">
      <h2><i class="fas fa-crystal-ball"></i><span data-lang="forecast_title">Ваш персональный астропрогноз</span></h2>
      <p id="forecastDate"></p>
    </div>
    
    <div class="forecast-content" id="forecastContent">
      <!-- Сюда будет вставлен прогноз -->
    </div>
    
    <div class="compatibility-container" id="compatibilityContainer">
      <h3><i class="fas fa-heart"></i><span data-lang="compatibility">Анализ совместимости</span></h3>
      <div class="compatibility-result" id="compatibilityResult">
        <p data-lang="compatibility_with">Совместимость с вашим партнером:</p>
        <div class="compatibility-meter">
          <div class="compatibility-progress" id="compatibilityProgress"></div>
        </div>
        <p id="compatibilityText"></p>
      </div>
    </div>
    
    <button id="consultationBtn">
      <i class="fas fa-calendar-check"></i><span data-lang="consultation">Записаться на персональную консультацию</span>
    </button>
    
    <div class="consultation-message" id="consultationMessage" data-lang="consultation_message">
      Функция персональной консультации будет доступна в следующем обновлении. Спасибо за интерес!
    </div>
    
    <button id="backToFormBtn">
      <i class="fas fa-arrow-left"></i><span data-lang="back_to_form">Вернуться к форме</span>
    </button>
  </div>

  <div class="notification-banner" id="notificationBanner"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Инициализация WebApp Telegram
      const tg = window.Telegram && window.Telegram.WebApp;
      if (tg) {
        tg.expand();
        tg.enableClosingConfirmation();
      }
      
      // Основные элементы
      const form = document.getElementById('astroForm');
      const submitBtn = document.getElementById('submitBtn');
      const loader = document.getElementById('loader');
      const forecastContainer = document.getElementById('forecastContainer');
      const forecastContent = document.getElementById('forecastContent');
      const forecastDate = document.getElementById('forecastDate');
      const backToFormBtn = document.getElementById('backToFormBtn');
      const themeSwitch = document.getElementById('themeSwitch');
      const languageSelect = document.getElementById('languageSelect');
      const starsContainer = document.getElementById('stars-container');
      const zodiacDisplay = document.getElementById('zodiacDisplay');
      const consultationBtn = document.getElementById('consultationBtn');
      const consultationMessage = document.getElementById('consultationMessage');
      const notificationBanner = document.getElementById('notificationBanner');
      const compatibilityAnalysis = document.getElementById('compatibilityAnalysis');
      const partnerForm = document.getElementById('partnerForm');
      const partnerBirthDate = document.getElementById('partner_birth_date');
      const partnerZodiacDisplay = document.getElementById('partnerZodiacDisplay');
      const compatibilityContainer = document.getElementById('compatibilityContainer');
      const compatibilityProgress = document.getElementById('compatibilityProgress');
      const compatibilityText = document.getElementById('compatibilityText');
      
      // Оптимизированное создание звездного фона
      function createStars() {
        starsContainer.innerHTML = '';
        const starsCount = window.innerWidth < 600 ? 100 : 200;
        const containerWidth = window.innerWidth;
        const containerHeight = window.innerHeight;
        const fragment = document.createDocumentFragment();
        
        for (let i = 0; i < starsCount; i++) {
          const star = document.createElement('div');
          star.classList.add('star');
          const size = Math.random() * 3;
          const x = Math.random() * containerWidth;
          const y = Math.random() * containerHeight;
          const duration = 2 + Math.random() * 3 + 's';
          const delay = Math.random() * 5 + 's';
          
          star.style.width = `${size}px`;
          star.style.height = `${size}px`;
          star.style.left = `${x}px`;
          star.style.top = `${y}px`;
          star.style.setProperty('--duration', duration);
          star.style.animationDelay = delay;
          
          fragment.appendChild(star);
        }
        
        starsContainer.appendChild(fragment);
      }
      createStars();
      window.addEventListener('resize', createStars);
      
      // Список городов для автодополнения
      const cities = ['Москва', 'Санкт-Петербург', 'Новосибирск', 'Екатеринбург', 'Казань', 
                     'Нижний Новгород', 'Челябинск', 'Самара', 'Омск', 'Ростов-на-Дону', 'Кострома', 'Тарко-Сале', 'Губкинский'];
      new Awesomplete(document.getElementById('birth_city'), {
        list: cities,
        minChars: 1,
        maxItems: 5,
        autoFirst: true
      });
      
      // Темная/светлая тема
      themeSwitch.addEventListener('click', function() {
        document.body.classList.toggle('light-mode');
        const icon = this.querySelector('i');
        if (document.body.classList.contains('light-mode')) {
          icon.classList.replace('fa-moon', 'fa-sun');
          document.documentElement.style.setProperty('--bg-color', '#f9f9ff');
          document.documentElement.style.setProperty('--text-color', '#333');
          document.documentElement.style.setProperty('--card-color', '#fff');
        } else {
          icon.classList.replace('fa-sun', 'fa-moon');
          document.documentElement.style.setProperty('--bg-color', '#0a0a1a');
          document.documentElement.style.setProperty('--text-color', '#f0f0f0');
          document.documentElement.style.setProperty('--card-color', 'rgba(22, 33, 62, 0.8)');
        }
        localStorage.setItem('themePreference', document.body.classList.contains('light-mode') ? 'light' : 'dark');
      });
      
      const savedTheme = localStorage.getItem('themePreference');
      if (savedTheme === 'light') {
        document.body.classList.add('light-mode');
        themeSwitch.querySelector('i').classList.replace('fa-moon', 'fa-sun');
        document.documentElement.style.setProperty('--bg-color', '#f9f9ff');
        document.documentElement.style.setProperty('--text-color', '#333');
        document.documentElement.style.setProperty('--card-color', '#fff');
      }
      
      // Функция определения знака зодиака
      function getZodiacSign(day, month) {
        if ((month == 3 && day >= 21) || (month == 4 && day <= 19)) return 'Овен';
        if ((month == 4 && day >= 20) || (month == 5 && day <= 20)) return 'Телец';
        if ((month == 5 && day >= 21) || (month == 6 && day <= 20)) return 'Близнецы';
        if ((month == 6 && day >= 21) || (month == 7 && day <= 22)) return 'Рак';
        if ((month == 7 && day >= 23) || (month == 8 && day <= 22)) return 'Лев';
        if ((month == 8 && day >= 23) || (month == 9 && day <= 22)) return 'Дева';
        if ((month == 9 && day >= 23) || (month == 10 && day <= 22)) return 'Весы';
        if ((month == 10 && day >= 23) || (month == 11 && day <= 21)) return 'Скорпион';
        if ((month == 11 && day >= 22) || (month == 12 && day <= 21)) return 'Стрелец';
        if ((month == 12 && day >= 22) || (month == 1 && day <= 19)) return 'Козерог';
        if ((month == 1 && day >= 20) || (month == 2 && day <= 18)) return 'Водолей';
        if ((month == 2 && day >= 19) || (month == 3 && day <= 20)) return 'Рыбы';
        return '';
      }
      
      // Знак зодиака пользователя
      document.getElementById('birth_date').addEventListener('change', function() {
        const date = new Date(this.value);
        const day = date.getDate();
        const month = date.getMonth() + 1;
        const zodiac = getZodiacSign(day, month);
        if (zodiac) {
          zodiacDisplay.textContent = zodiac;
          zodiacDisplay.style.display = 'inline-block';
        } else {
          zodiacDisplay.style.display = 'none';
        }
      });
      
      // Знак зодиака партнера
      partnerBirthDate.addEventListener('change', function() {
        const date = new Date(this.value);
        const day = date.getDate();
        const month = date.getMonth() + 1;
        const zodiac = getZodiacSign(day, month);
        if (zodiac) {
          partnerZodiacDisplay.textContent = zodiac;
          partnerZodiacDisplay.style.display = 'inline-block';
        } else {
          partnerZodiacDisplay.style.display = 'none';
        }
      });
      
      // Показать/скрыть форму партнера
      compatibilityAnalysis.addEventListener('change', function() {
        partnerForm.style.display = this.checked ? 'block' : 'none';
      });
      
      // Функция расчета совместимости
      function calculateCompatibility(zodiac1, zodiac2) {
        if (!zodiac1 || !zodiac2) return { score: 0, text: translations[languageSelect.value].insufficient_data };
        
        const compatibilityMap = {
          'Овен': { 'Овен': 70, 'Телец': 40, 'Близнецы': 80, 'Рак': 30, 'Лев': 90, 'Дева': 50, 'Весы': 60, 'Скорпион': 45, 'Стрелец': 85, 'Козерог': 55, 'Водолей': 75, 'Рыбы': 35 },
          'Телец': { 'Овен': 40, 'Телец': 75, 'Близнецы': 50, 'Рак': 85, 'Лев': 45, 'Дева': 90, 'Весы': 65, 'Скорпион': 80, 'Стрелец': 55, 'Козерог': 95, 'Водолей': 60, 'Рыбы': 70 },
          'Близнецы': { 'Овен': 80, 'Телец': 50, 'Близнецы': 65, 'Рак': 40, 'Лев': 70, 'Дева': 55, 'Весы': 85, 'Скорпион': 60, 'Стрелец': 75, 'Козерог': 45, 'Водолей': 90, 'Рыбы': 50 },
          'Рак': { 'Овен': 30, 'Телец': 85, 'Близнецы': 40, 'Рак': 80, 'Лев': 35, 'Дева': 75, 'Весы': 50, 'Скорпион': 90, 'Стрелец': 45, 'Козерог': 70, 'Водолей': 55, 'Рыбы': 95 },
          'Лев': { 'Овен': 90, 'Телец': 45, 'Близнецы': 70, 'Рак': 35, 'Лев': 85, 'Дева': 40, 'Весы': 75, 'Скорпион': 50, 'Стрелец': 80, 'Козерог': 55, 'Водолей': 65, 'Рыбы': 60 },
          'Дева': { 'Овен': 50, 'Телец': 90, 'Близнецы': 55, 'Рак': 75, 'Лев': 40, 'Дева': 70, 'Весы': 60, 'Скорпион': 85, 'Стрелец': 45, 'Козерог': 80, 'Водолей': 50, 'Рыбы': 65 },
          'Весы': { 'Овен': 60, 'Телец': 65, 'Близнецы': 85, 'Рак': 50, 'Лев': 75, 'Дева': 60, 'Весы': 75, 'Скорпион': 55, 'Стрелец': 70, 'Козерог': 45, 'Водолей': 80, 'Рыбы': 65 },
          'Скорпион': { 'Овен': 45, 'Телец': 80, 'Близнецы': 60, 'Рак': 90, 'Лев': 50, 'Дева': 85, 'Весы': 55, 'Скорпион': 95, 'Стрелец': 40, 'Козерог': 75, 'Водолей': 65, 'Рыбы': 85 },
          'Стрелец': { 'Овен': 85, 'Телец': 55, 'Близнецы': 75, 'Рак': 45, 'Лев': 80, 'Дева': 45, 'Весы': 70, 'Скорпион': 40, 'Стрелец': 90, 'Козерог': 50, 'Водолей': 85, 'Рыбы': 60 },
          'Козерог': { 'Овен': 55, 'Телец': 95, 'Близнецы': 45, 'Рак': 70, 'Лев': 55, 'Дева': 80, 'Весы': 45, 'Скорпион': 75, 'Стрелец': 50, 'Козерог': 85, 'Водолей': 60, 'Рыбы': 90 },
          'Водолей': { 'Овен': 75, 'Телец': 60, 'Близнецы': 90, 'Рак': 55, 'Лев': 65, 'Дева': 50, 'Весы': 80, 'Скорпион': 65, 'Стрелец': 85, 'Козерог': 60, 'Водолей': 75, 'Рыбы': 70 },
          'Рыбы': { 'Овен': 35, 'Телец': 70, 'Близнецы': 50, 'Рак': 95, 'Лев': 60, 'Дева': 65, 'Весы': 65, 'Скорпион': 85, 'Стрелец': 60, 'Козерог': 90, 'Водолей': 70, 'Рыбы': 80 }
        };
        
        const score = compatibilityMap[zodiac1][zodiac2] || 50;
        let text = '';
        if (score >= 80) {
          text = translations[languageSelect.value].high_compatibility.replace('{z1}', zodiac1).replace('{z2}', zodiac2);
        } else if (score >= 60) {
          text = translations[languageSelect.value].moderate_compatibility.replace('{z1}', zodiac1).replace('{z2}', zodiac2);
        } else {
          text = translations[languageSelect.value].low_compatibility.replace('{z1}', zodiac1).replace('{z2}', zodiac2);
        }
        
        return { score, text };
      }
      
      // Переводы
      const translations = {
        ru: {
          name: 'Имя:',
          'name-error': 'Пожалуйста, введите ваше имя',
          birth_date: 'Дата рождения:',
          'birth_date-error': 'Пожалуйста, введите корректную дату',
          birth_time: 'Время рождения (необязательно):',
          time_format: 'Формат: чч:мм (24-часовой)',
          birth_city: 'Город рождения:',
          'birth_city-error': 'Пожалуйста, укажите город рождения',
          gender: 'Пол:',
          'gender-error': 'Пожалуйста, выберите пол',
          interest: 'Интерес:',
          'interest-error': 'Пожалуйста, выберите интерес',
          relationship: 'Семейное положение:',
          'relationship-error': 'Пожалуйста, укажите семейное положение',
          children: 'Есть ли дети:',
          'children-error': 'Пожалуйста, укажите, есть ли у вас дети',
          favorite_color: 'Любимый цвет:',
          'color-error': 'Пожалуйста, выберите цвет',
          fears: 'Страхи или тревоги (необязательно):',
          extras: 'Дополнительные возможности:',
          newsletter: 'Получать еженедельный астропрогноз',
          compatibility_analysis: 'Анализ совместимости с партнером',
          partner_data: 'Данные партнера',
          partner_name: 'Имя партнера:',
          'partner_name-error': 'Пожалуйста, введите имя партнера',
          partner_birth_date: 'Дата рождения партнера:',
          'partner_birth_date-error': 'Пожалуйста, введите корректную дату',
          get_forecast: 'Получить прогноз',
          forecast_title: 'Ваш персональный астропрогноз',
          compatibility: 'Анализ совместимости',
          compatibility_with: 'Совместимость с вашим партнером:',
          consultation: 'Записаться на персональную консультацию',
          consultation_message: 'Функция персональной консультации будет доступна в следующем обновлении. Спасибо за интерес!',
          back_to_form: 'Вернуться к форме',
          select: 'Выберите',
          male: 'Мужской',
          female: 'Женский',
          love: 'Любовь и отношения',
          career: 'Карьера и бизнес',
          finance: 'Финансы и инвестиции',
          health: 'Здоровье и благополучие',
          family: 'Семья и дети',
          growth: 'Личностный рост',
          creativity: 'Творчество и вдохновение',
          travel: 'Путешествия и переезды',
          spiritual: 'Духовное развитие',
          education: 'Образование и обучение',
          decisions: 'Важные решения',
          general: 'Общий прогноз',
          in_relationship: 'В отношениях',
          not_in_relationship: 'Не в отношениях',
          searching: 'В поиске',
          complicated: 'В сложных отношениях',
          yes: 'Да',
          no: 'Нет',
          planning: 'Планируем',
          insufficient_data: 'Недостаточно данных для анализа',
          high_compatibility: '{z1} и {z2} имеют высокую совместимость. Ваши отношения будут гармоничными!',
          moderate_compatibility: '{z1} и {z2} имеют среднюю совместимость. Возможны небольшие разногласия.',
          low_compatibility: '{z1} и {z2} имеют низкую совместимость. Потребуется больше усилий для гармонии.'
        },
        en: {
          name: 'Name:',
          'name-error': 'Please enter your name',
          birth_date: 'Date of Birth:',
          'birth_date-error': 'Please enter a valid date',
          birth_time: 'Time of Birth (optional):',
          time_format: 'Format: hh:mm (24-hour)',
          birth_city: 'City of Birth:',
          'birth_city-error': 'Please specify city of birth',
          gender: 'Gender:',
          'gender-error': 'Please select gender',
          interest: 'Interest:',
          'interest-error': 'Please select an interest',
          relationship: 'Relationship Status:',
          'relationship-error': 'Please specify relationship status',
          children: 'Do you have children:',
          'children-error': 'Please specify if you have children',
          favorite_color: 'Favorite Color:',
          'color-error': 'Please select a color',
          fears: 'Fears or Worries (optional):',
          extras: 'Additional Features:',
          newsletter: 'Receive weekly astro forecast',
          compatibility_analysis: 'Partner compatibility analysis',
          partner_data: 'Partner Details',
          partner_name: 'Partner Name:',
          'partner_name-error': 'Please enter partner name',
          partner_birth_date: 'Partner Date of Birth:',
          'partner_birth_date-error': 'Please enter a valid date',
          get_forecast: 'Get Forecast',
          forecast_title: 'Your Personal Astro Forecast',
          compatibility: 'Compatibility Analysis',
          compatibility_with: 'Compatibility with your partner:',
          consultation: 'Book a Personal Consultation',
          consultation_message: 'Personal consultation feature will be available in the next update. Thank you for your interest!',
          back_to_form: 'Back to Form',
          select: 'Select',
          male: 'Male',
          female: 'Female',
          love: 'Love and Relationships',
          career: 'Career and Business',
          finance: 'Finance and Investments',
          health: 'Health and Well-being',
          family: 'Family and Children',
          growth: 'Personal Growth',
          creativity: 'Creativity and Inspiration',
          travel: 'Travel and Relocation',
          spiritual: 'Spiritual Development',
          education: 'Education and Learning',
          decisions: 'Important Decisions',
          general: 'General Forecast',
          in_relationship: 'In a relationship',
          not_in_relationship: 'Not in a relationship',
          searching: 'Searching',
          complicated: 'In complicated relationship',
          yes: 'Yes',
          no: 'No',
          planning: 'Planning',
          insufficient_data: 'Insufficient data for analysis',
          high_compatibility: '{z1} and {z2} have high compatibility. Your relationship will be harmonious!',
          moderate_compatibility: '{z1} and {z2} have moderate compatibility. Some disagreements may arise.',
          low_compatibility: '{z1} and {z2} have low compatibility. More effort will be needed for harmony.'
        }
      };
      
      // Переключение языка
      function updateLanguage() {
        const lang = languageSelect.value;
        document.querySelectorAll('[data-lang]').forEach(el => {
          const key = el.getAttribute('data-lang');
          if (translations[lang][key]) {
            el.textContent = translations[lang][key];
          }
        });
        localStorage.setItem('languagePreference', lang);
      }
      languageSelect.addEventListener('change', updateLanguage);
      const savedLanguage = localStorage.getItem('languagePreference');
      if (savedLanguage) {
        languageSelect.value = savedLanguage;
        updateLanguage();
      }
      
      // Сохранение и загрузка формы
      function loadFormData() {
        const savedData = localStorage.getItem('astroFormData');
        if (savedData) {
          const data = JSON.parse(savedData);
          document.getElementById('name').value = data.name || '';
          document.getElementById('birth_date').value = data.birth_date || '';
          if (data.birth_date) {
            const date = new Date(data.birth_date);
            const zodiac = getZodiacSign(date.getDate(), date.getMonth() + 1);
            zodiacDisplay.textContent = zodiac;
            zodiacDisplay.style.display = zodiac ? 'inline-block' : 'none';
          }
          document.getElementById('birth_time').value = data.birth_time || '';
          document.getElementById('birth_city').value = data.birth_city || '';
          document.getElementById('gender').value = data.gender || '';
          document.getElementById('interest').value = data.interest || '';
          document.getElementById('relationship').value = data.relationship || '';
          document.getElementById('children').value = data.children || '';
          document.getElementById('favorite_color').value = data.favorite_color || '#6a5acd';
          document.getElementById('fears').value = data.fears || '';
          document.getElementById('receiveNewsletter').checked = data.receive_newsletter || false;
          document.getElementById('compatibilityAnalysis').checked = data.compatibility_analysis || false;
          partnerForm.style.display = data.compatibility_analysis ? 'block' : 'none';
          document.getElementById('partner_name').value = data.partner_name || '';
          document.getElementById('partner_birth_date').value = data.partner_birth_date || '';
          if (data.partner_birth_date) {
            const date = new Date(data.partner_birth_date);
            const zodiac = getZodiacSign(date.getDate(), date.getMonth() + 1);
            partnerZodiacDisplay.textContent = zodiac;
            partnerZodiacDisplay.style.display = zodiac ? 'inline-block' : 'none';
          }
        }
      }
      loadFormData();
      
      // Обработка формы
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        let valid = true;
        
        // Валидация
        if (!document.getElementById('name').value) {
          document.getElementById('name-error').style.display = 'block';
          valid = false;
        } else {
          document.getElementById('name-error').style.display = 'none';
        }
        if (!document.getElementById('birth_date').value) {
          document.getElementById('birth_date-error').style.display = 'block';
          valid = false;
        } else {
          document.getElementById('birth_date-error').style.display = 'none';
        }
        if (!document.getElementById('birth_city').value) {
          document.getElementById('birth_city-error').style.display = 'block';
          valid = false;
        } else {
          document.getElementById('birth_city-error').style.display = 'none';
        }
        if (!document.getElementById('gender').value) {
          document.getElementById('gender-error').style.display = 'block';
          valid = false;
        } else {
          document.getElementById('gender-error').style.display = 'none';
        }
        if (!document.getElementById('interest').value) {
          document.getElementById('interest-error').style.display = 'block';
          valid = false;
        } else {
          document.getElementById('interest-error').style.display = 'none';
        }
        if (!document.getElementById('relationship').value) {
          document.getElementById('relationship-error').style.display = 'block';
          valid = false;
        } else {
          document.getElementById('relationship-error').style.display = 'none';
        }
        if (!document.getElementById('children').value) {
          document.getElementById('children-error').style.display = 'block';
          valid = false;
        } else {
          document.getElementById('children-error').style.display = 'none';
        }
        if (!document.getElementById('favorite_color').value) {
          document.getElementById('favorite_color-error').style.display = 'block';
          valid = false;
        } else {
          document.getElementById('favorite_color-error').style.display = 'none';
        }
        if (compatibilityAnalysis.checked) {
          if (!document.getElementById('partner_name').value) {
            document.getElementById('partner_name-error').style.display = 'block';
            valid = false;
          } else {
            document.getElementById('partner_name-error').style.display = 'none';
          }
          if (!document.getElementById('partner_birth_date').value) {
            document.getElementById('partner_birth_date-error').style.display = 'block';
            valid = false;
          } else {
            document.getElementById('partner_birth_date-error').style.display = 'none';
          }
        }
        
        if (valid) {
          submitBtn.disabled = true;
          loader.style.display = 'inline-block';
          
          const formData = new FormData(form);
          const data = Object.fromEntries(formData);
          localStorage.setItem('astroFormData', JSON.stringify(data));
          
          // Симуляция запроса к API
          setTimeout(() => {
            // Генерация прогноза (плейсхолдер)
            forecastContent.innerHTML = `
              <div class="forecast-section">
                <h3><i class="fas fa-star"></i>${translations[languageSelect.value].general}</h3>
                <p>Сегодня звёзды советуют вам сосредоточиться на ${data.interest.toLowerCase()}. Ваши усилия принесут успех!</p>
              </div>
            `;
            forecastDate.textContent = new Date().toLocaleDateString(languageSelect.value, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            // Совместимость
            if (compatibilityAnalysis.checked) {
              const userZodiac = zodiacDisplay.textContent;
              const partnerZodiac = partnerZodiacDisplay.textContent;
              const compat = calculateCompatibility(userZodiac, partnerZodiac);
              compatibilityProgress.style.width = `${compat.score}%`;
              compatibilityText.textContent = compat.text;
              compatibilityContainer.style.display = 'block';
            } else {
              compatibilityContainer.style.display = 'none';
            }
            
            form.style.display = 'none';
            document.getElementById('formTitle').style.display = 'none';
            forecastContainer.style.display = 'block';
            submitBtn.disabled = false;
            loader.style.display = 'none';
            
            // Уведомление
            notificationBanner.textContent = translations[languageSelect.value][data.receive_newsletter ? 'subscribed' : 'forecast_ready'] || 'Прогноз готов!';
            notificationBanner.style.display = 'block';
            setTimeout(() => notificationBanner.style.display = 'none', 3000);
          }, 1500);
        }
      });
      
      // Кнопка консультации
      consultationBtn.addEventListener('click', () => {
        consultationMessage.style.display = 'block';
        setTimeout(() => consultationMessage.style.display = 'none', 5000);
      });
      
      // Кнопка возврата
      backToFormBtn.addEventListener('click', () => {
        forecastContainer.style.display = 'none';
        form.style.display = 'block';
        document.getElementById('formTitle').style.display = 'block';
      });
      
      // Инициализация Telegram
      if (tg && tg.initDataUnsafe.user) {
        document.getElementById('name').value = tg.initDataUnsafe.user.first_name || '';
      }
    });
  </script>
</body>
</html>
```
